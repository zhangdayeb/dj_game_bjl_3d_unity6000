<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <title>ç™¾å®¶ä¹æ¸¸æˆ</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="ä¸“ä¸šçš„åœ¨çº¿ç™¾å®¶ä¹æ¸¸æˆå¹³å°ï¼Œæ”¯æŒå®æ—¶è§†é¢‘ç›´æ’­å’Œå¤šç§æŠ•æ³¨ç©æ³•">
    <meta name="keywords" content="ç™¾å®¶ä¹,åœ¨çº¿æ¸¸æˆ,çœŸäººå¨±ä¹,WebGLæ¸¸æˆ">
    <meta name="author" content="Baccarat Game Team">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="ç™¾å®¶ä¹æ¸¸æˆ">
    <meta property="og:description" content="ä¸“ä¸šçš„åœ¨çº¿ç™¾å®¶ä¹æ¸¸æˆå¹³å°">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{{ UNITY_CUSTOM_WEBSITE_URL }}}">
    <meta property="og:image" content="TemplateData/og-image.jpg">
    
    <!-- Favicon -->
    <link rel="icon" href="Assets/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="Assets/favicon.ico" type="image/x-icon">
    
    <!-- Preload Critical Resources -->
    <link rel="preload" href="TemplateData/style.css" as="style">
    <link rel="preload" href="Build/{{{ LOADER_FILENAME }}}" as="script">
    <link rel="preload" href="Build/{{{ FRAMEWORK_FILENAME }}}" as="script">
    <link rel="prefetch" href="Build/{{{ CODE_FILENAME }}}" as="fetch" crossorigin>
    <link rel="prefetch" href="Build/{{{ DATA_FILENAME }}}" as="fetch" crossorigin>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="TemplateData/style.css">
    
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <style>
        /* å…¨å±€æ ·å¼é‡ç½® */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            background: #000;
            overflow: hidden;
            user-select: none;
        }
        
        /* åŠ è½½ç•Œé¢æ ·å¼ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-content {
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        
        .loading-logo {
            font-size: 48px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        .loading-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .loading-subtitle {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 30px;
        }
        
        /* è¯¦ç»†åŠ è½½æ­¥éª¤ */
        .loading-steps {
            margin-bottom: 30px;
            text-align: left;
        }
        
        .loading-step {
            display: flex;
            align-items: center;
            padding: 8px 0;
            font-size: 14px;
            opacity: 0.6;
            transition: all 0.3s ease;
        }
        
        .loading-step.active {
            opacity: 1;
            color: #4CAF50;
        }
        
        .loading-step.completed {
            opacity: 1;
            color: #4CAF50;
        }
        
        .loading-step.error {
            opacity: 1;
            color: #f44336;
        }
        
        .step-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-container {
            width: 100%;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #2196F3);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            margin-top: 10px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .file-size-info {
            opacity: 0.7;
            font-size: 11px;
        }
        
        /* æ—¶é—´ä¼°ç®— */
        .time-estimate {
            margin-top: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            font-size: 12px;
        }
        
        .time-estimate .label {
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .time-estimate .value {
            font-weight: bold;
            color: #4CAF50;
        }
        
        /* æ¸¸æˆä¸»ç•Œé¢ */
        .game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: none;
        }
        
        .game-layout {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* è§†é¢‘åŒºåŸŸ - é¡¶éƒ¨å›ºå®š */
        .video-section {
            position: relative;
            height: 40vh;
            min-height: 300px;
            background: #1a1a1a;
            border-bottom: 2px solid #333;
        }
        
        /* Unityæ¸¸æˆåŒºåŸŸ - ä¸­é—´è‡ªé€‚åº” */
        .unity-section {
            flex: 1;
            position: relative;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 0; /* é‡è¦ï¼šå…è®¸flexæ”¶ç¼© */
        }
        
        #unity-canvas {
            width: 100% !important;
            height: 100% !important;
            max-width: 100%;
            max-height: 100%;
            border-radius: 0;
            object-fit: contain;
            display: block;
        }
        
        /* è·¯å•åŒºåŸŸ - åº•éƒ¨å›ºå®š */
        .roadmap-section {
            position: relative;
            height: 25vh;
            min-height: 200px;
            background: #2a2a2a;
            border-top: 2px solid #333;
        }
        
        /* iframe åŸºç¡€æ ·å¼ */
        .iframe-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
        }
        
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
        
        /* è§†é¢‘iframeæ ·å¼ */
        .video-iframe-container {
            background: #000;
        }
        
        .video-iframe-container iframe {
            background: #000;
        }
        
        /* è·¯å•iframeæ ·å¼ */
        .roadmap-iframe-container {
            background: #f5f5f5;
        }
        
        .roadmap-iframe-container iframe {
            background: #f5f5f5;
        }
        
        /* åŒºåŸŸæ ‡ç­¾ */
        .section-label {
            position: absolute;
            top: 5px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            z-index: 100;
            pointer-events: none;
        }
        
        /* é”™è¯¯ç•Œé¢ */
        .error-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #c62828 0%, #d32f2f 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10000;
            text-align: center;
            padding: 20px;
        }
        
        .error-content h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .error-content p {
            margin-bottom: 20px;
            opacity: 0.9;
            line-height: 1.5;
        }
        
        .error-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-step.active {
            animation: fadeIn 0.3s ease;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .video-section {
                height: 35vh;
                min-height: 250px;
            }
            
            .roadmap-section {
                height: 20vh;
                min-height: 150px;
            }
            
            .loading-title {
                font-size: 20px;
            }
            
            .loading-logo {
                font-size: 36px;
            }
        }
        
        @media (max-width: 480px) {
            .video-section {
                height: 30vh;
                min-height: 200px;
            }
            
            .roadmap-section {
                height: 18vh;
                min-height: 120px;
            }
        }
    </style>
    
    <!-- å…¼å®¹æ€§æ£€æµ‹è„šæœ¬ -->
    <script>
        // è®¾å¤‡å…¼å®¹æ€§ç®¡ç†å™¨
        window.DeviceCompatibilityManager = {
            isSimulator: false,
            isMobile: false,
            maxTextureSize: 0,
            
            detectEnvironment: function() {
                const userAgent = navigator.userAgent;
                
                // æ£€æµ‹æ¨¡æ‹Ÿå™¨
                this.isSimulator = window.navigator.webdriver || 
                                  window.outerHeight === 0 || 
                                  window.outerWidth === 0 ||
                                  userAgent.includes('HeadlessChrome') ||
                                  (window.chrome && window.chrome.runtime);
                
                // æ£€æµ‹ç§»åŠ¨è®¾å¤‡
                this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
                
                return { isSimulator: this.isSimulator, isMobile: this.isMobile };
            },
            
            getWebGLCapabilities: function() {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    
                    if (gl) {
                        this.maxTextureSize = gl.getParameter(gl.MAX_TEXTURE_SIZE);
                        return {
                            maxTextureSize: this.maxTextureSize,
                            renderer: gl.getParameter(gl.getExtension('WEBGL_debug_renderer_info')?.UNMASKED_RENDERER_WEBGL) || 'Unknown'
                        };
                    }
                } catch (e) {
                    console.error('WebGLæ£€æµ‹å¤±è´¥:', e);
                }
                return null;
            },
            
            getOptimalCanvasSize: function(targetWidth, targetHeight) {
                const capabilities = this.getWebGLCapabilities();
                if (!capabilities) return { width: 400, height: 600 };
                
                let maxSafeSize;
                if (this.isSimulator) {
                    maxSafeSize = Math.min(capabilities.maxTextureSize, 512);
                } else if (this.isMobile) {
                    maxSafeSize = Math.min(capabilities.maxTextureSize, 1024);
                } else {
                    maxSafeSize = Math.min(capabilities.maxTextureSize, 2048);
                }
                
                const aspectRatio = targetWidth / targetHeight;
                let safeWidth, safeHeight;
                
                if (aspectRatio > 1) {
                    safeWidth = Math.min(targetWidth, maxSafeSize);
                    safeHeight = Math.round(safeWidth / aspectRatio);
                } else {
                    safeHeight = Math.min(targetHeight, maxSafeSize);
                    safeWidth = Math.round(safeHeight * aspectRatio);
                }
                
                return { 
                    width: Math.min(safeWidth, maxSafeSize), 
                    height: Math.min(safeHeight, maxSafeSize) 
                };
            },
            
            getOptimizedUnityConfig: function() {
                return {
                    dataUrl: "Build/{{{ DATA_FILENAME }}}",
                    frameworkUrl: "Build/{{{ FRAMEWORK_FILENAME }}}",
                    codeUrl: "Build/{{{ CODE_FILENAME }}}",
                    streamingAssetsUrl: "StreamingAssets",
                    companyName: "{{{ COMPANY_NAME }}}",
                    productName: "{{{ PRODUCT_NAME }}}",
                    productVersion: "{{{ PRODUCT_VERSION }}}",
                    devicePixelRatio: this.isSimulator ? 1 : Math.min(window.devicePixelRatio || 1, 2)
                };
            }
        };
        
        // WebGLæ”¯æŒæ£€æµ‹
        function checkWebGLSupport() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                return !!gl;
            } catch(e) {
                return false;
            }
        }
        
        if (!checkWebGLSupport()) {
            document.addEventListener('DOMContentLoaded', function() {
                document.body.innerHTML = `
                    <div class="error-overlay" style="display: flex;">
                        <div class="error-content">
                            <h2>ğŸš« WebGL ä¸æ”¯æŒ</h2>
                            <p>æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebGLï¼Œæ— æ³•è¿è¡Œæ¸¸æˆ</p>
                            <p><strong>æ¨èæµè§ˆå™¨ï¼š</strong> Chromeã€Firefoxã€Safariã€Edge</p>
                            <div class="error-actions">
                                <button onclick="window.location.reload()">é‡æ–°æ£€æµ‹</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
    </script>
</head>

<body>
    <!-- è¯¦ç»†åŠ è½½ç•Œé¢ -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <!-- Logoå’Œæ ‡é¢˜ -->
            <div class="loading-logo">ğŸ°</div>
            <div class="loading-title">ç™¾å®¶ä¹æ¸¸æˆ</div>
            <div class="loading-subtitle">æ­£åœ¨åŠ è½½æ¸¸æˆå¼•æ“å’Œèµ„æºæ–‡ä»¶...</div>
            
            <!-- åŠ è½½æ­¥éª¤ -->
            <div class="loading-steps">
                <div class="loading-step" id="step-env">
                    <div class="step-icon">ğŸ”</div>
                    <div>æ£€æµ‹è®¾å¤‡ç¯å¢ƒå’Œå…¼å®¹æ€§</div>
                </div>
                <div class="loading-step" id="step-webgl">
                    <div class="step-icon">ğŸ®</div>
                    <div>åˆå§‹åŒ–WebGLæ¸²æŸ“å¼•æ“</div>
                </div>
                <div class="loading-step" id="step-loader">
                    <div class="step-icon">ğŸ“¦</div>
                    <div>åŠ è½½Unityæ ¸å¿ƒæ¨¡å—</div>
                </div>
                <div class="loading-step" id="step-framework">
                    <div class="step-icon">âš™ï¸</div>
                    <div>åˆå§‹åŒ–æ¸¸æˆæ¡†æ¶</div>
                </div>
                <div class="loading-step" id="step-assets">
                    <div class="step-icon">ğŸ¨</div>
                    <div>ä¸‹è½½æ¸¸æˆèµ„æºæ–‡ä»¶</div>
                </div>
                <div class="loading-step" id="step-complete">
                    <div class="step-icon">âœ…</div>
                    <div>å¯åŠ¨æ¸¸æˆå®ä¾‹</div>
                </div>
            </div>
            
            <!-- è¿›åº¦æ¡ -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text">
                    <span id="progress-status">å‡†å¤‡ä¸­...</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div class="file-size-info" id="file-size-info">
                    é¢„è®¡ä¸‹è½½: <span id="estimated-size">è®¡ç®—ä¸­...</span>
                </div>
            </div>
            
            <!-- æ—¶é—´ä¼°ç®— -->
            <div class="time-estimate" id="time-estimate" style="display: none;">
                <div class="label">é¢„è®¡å‰©ä½™æ—¶é—´</div>
                <div class="value" id="time-remaining">è®¡ç®—ä¸­...</div>
            </div>
        </div>
    </div>
    
    <!-- æ¸¸æˆä¸»ç•Œé¢ -->
    <div class="game-container" id="game-container">
        <div class="game-layout">
            <!-- è§†é¢‘åŒºåŸŸ - é¡¶éƒ¨ -->
            <div class="video-section">
                <div class="section-label">è§†é¢‘ç›´æ’­åŒº</div>
                <!-- è¿œæ™¯è§†é¢‘ -->
                <div id="video-far-container" class="iframe-container video-iframe-container" style="display: none;">
                    <!-- iframe will be inserted here -->
                </div>
                <!-- è¿‘æ™¯è§†é¢‘ -->
                <div id="video-near-container" class="iframe-container video-iframe-container" style="display: none;">
                    <!-- iframe will be inserted here -->
                </div>
            </div>
            
            <!-- Unityæ¸¸æˆåŒºåŸŸ - ä¸­é—´ -->
            <div class="unity-section">
                <canvas id="unity-canvas" tabindex="-1"></canvas>
            </div>
            
            <!-- è·¯å•åŒºåŸŸ - åº•éƒ¨ -->
            <div class="roadmap-section">
                <div class="section-label">æ¸¸æˆè·¯å•</div>
                <div id="roadmap-container" class="iframe-container roadmap-iframe-container" style="display: none;">
                    <!-- iframe will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- é”™è¯¯ç•Œé¢ -->
    <div class="error-overlay" id="error-overlay">
        <div class="error-content">
            <h2>ğŸš« åŠ è½½å¤±è´¥</h2>
            <p id="error-message">æ¸¸æˆåŠ è½½è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯</p>
            <div class="error-actions">
                <button onclick="window.location.reload()">ğŸ”„ é‡æ–°åŠ è½½</button>
                <button onclick="toggleCompatibilityMode()">ğŸ› ï¸ å…¼å®¹æ¨¡å¼</button>
                <button onclick="contactSupport()">ğŸ“ è”ç³»å®¢æœ</button>
            </div>
        </div>
    </div>
    
    <!-- Unityè„šæœ¬ -->
    <script src="Build/{{{ LOADER_FILENAME }}}"></script>
    
    <!-- è¾…åŠ©è„šæœ¬ -->
    <script src="TemplateData/unity-bridge.js"></script>
    <script src="TemplateData/safari-compatibility.js"></script>
    <script src="TemplateData/error-handler.js"></script>
    
    <!-- ç™¾å®¶ä¹ä¸“ç”¨iframeç®¡ç†å™¨ -->
    <script>
        // ç™¾å®¶ä¹iframeç®¡ç†å™¨
        window.BaccaratIframeManager = {
            containers: new Map(),
            
            // iframeç±»å‹å®šä¹‰
            IFRAME_TYPES: {
                VIDEO_FAR: 'video-far',      // è¿œæ™¯è§†é¢‘
                VIDEO_NEAR: 'video-near',    // è¿‘æ™¯è§†é¢‘  
                ROADMAP: 'roadmap'           // è·¯å•
            },
            
            // åˆ›å»ºiframe
            createIframe: function(containerId, url) {
                try {
                    console.log('ğŸ¯ åˆ›å»ºç™¾å®¶ä¹iframe:', containerId, url);
                    
                    // ç¡®å®šiframeç±»å‹å’Œç›®æ ‡å®¹å™¨
                    let targetContainer, iframeType;
                    
                    if (containerId.includes('video') || containerId.includes('camera')) {
                        // è§†é¢‘iframe - æ£€æŸ¥æ˜¯è¿œæ™¯è¿˜æ˜¯è¿‘æ™¯
                        if (containerId.includes('far') || containerId.includes('wide') || containerId.includes('overview')) {
                            targetContainer = document.getElementById('video-far-container');
                            iframeType = this.IFRAME_TYPES.VIDEO_FAR;
                        } else {
                            targetContainer = document.getElementById('video-near-container');
                            iframeType = this.IFRAME_TYPES.VIDEO_NEAR;
                        }
                    } else if (containerId.includes('roadmap') || containerId.includes('road') || containerId.includes('history')) {
                        // è·¯å•iframe
                        targetContainer = document.getElementById('roadmap-container');
                        iframeType = this.IFRAME_TYPES.ROADMAP;
                    } else {
                        // é»˜è®¤ä¸ºè¿‘æ™¯è§†é¢‘
                        targetContainer = document.getElementById('video-near-container');
                        iframeType = this.IFRAME_TYPES.VIDEO_NEAR;
                    }
                    
                    if (!targetContainer) {
                        console.error('âŒ æœªæ‰¾åˆ°ç›®æ ‡å®¹å™¨:', containerId);
                        return false;
                    }
                    
                    // æ¸…ç†ç°æœ‰å†…å®¹
                    targetContainer.innerHTML = '';
                    
                    // åˆ›å»ºiframe
                    const iframe = document.createElement('iframe');
                    iframe.src = url;
                    iframe.style.cssText = `
                        width: 100%;
                        height: 100%;
                        border: none;
                        display: block;
                    `;
                    
                    // æ ¹æ®ç±»å‹è®¾ç½®iframeå±æ€§
                    if (iframeType === this.IFRAME_TYPES.ROADMAP) {
                        // è·¯å•iframeé…ç½®
                        iframe.setAttribute('scrolling', 'auto');
                        iframe.setAttribute('sandbox', 'allow-same-origin allow-scripts allow-forms');
                        iframe.style.background = '#f5f5f5';
                    } else {
                        // è§†é¢‘iframeé…ç½®
                        iframe.setAttribute('allowfullscreen', 'true');
                        iframe.setAttribute('scrolling', 'no');
                        iframe.setAttribute('allow', 'autoplay; fullscreen; camera; microphone');
                        iframe.setAttribute('sandbox', 'allow-same-origin allow-scripts allow-forms allow-presentation');
                        iframe.style.background = '#000';
                    }
                    
                    iframe.setAttribute('frameborder', '0');
                    
                    // iframeäº‹ä»¶å¤„ç†
                    iframe.onload = () => {
                        console.log(`âœ… ${iframeType} iframeåŠ è½½å®Œæˆ:`, url);
                        
                        // å°è¯•ä¼˜åŒ–iframeå†…å®¹
                        this.optimizeIframeContent(iframe, iframeType);
                    };
                    
                    iframe.onerror = (error) => {
                        console.error(`âŒ ${iframeType} iframeåŠ è½½å¤±è´¥:`, error);
                        this.showIframeError(targetContainer, url, iframeType);
                    };
                    
                    // æ·»åŠ åˆ°å®¹å™¨
                    targetContainer.appendChild(iframe);
                    targetContainer.style.display = 'block';
                    
                    // ä¿å­˜å¼•ç”¨
                    this.containers.set(containerId, {
                        container: targetContainer,
                        iframe: iframe,
                        url: url,
                        type: iframeType
                    });
                    
                    console.log(`âœ… ${iframeType} iframeåˆ›å»ºæˆåŠŸ:`, containerId);
                    return true;
                    
                } catch (error) {
                    console.error('âŒ iframeåˆ›å»ºå¤±è´¥:', error);
                    return false;
                }
            },
            
            // ä¼˜åŒ–iframeå†…å®¹
            optimizeIframeContent: function(iframe, type) {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (!iframeDoc) return;
                    
                    const style = iframeDoc.createElement('style');
                    
                    if (type === this.IFRAME_TYPES.ROADMAP) {
                        // è·¯å•æ ·å¼ä¼˜åŒ–
                        style.textContent = `
                            body { 
                                margin: 0; 
                                padding: 8px; 
                                font-family: Arial, sans-serif;
                                background: #f8f9fa;
                                overflow-x: auto;
                                font-size: 12px;
                            }
                            table { 
                                width: 100%; 
                                border-collapse: collapse; 
                                margin-bottom: 10px;
                            }
                            th, td { 
                                padding: 4px 6px; 
                                border: 1px solid #ddd; 
                                text-align: center;
                                font-size: 11px;
                            }
                            th { 
                                background: #e9ecef; 
                                font-weight: bold;
                            }
                            .roadmap-grid {
                                display: grid;
                                gap: 2px;
                                padding: 4px;
                            }
                            .road-item {
                                min-height: 20px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 10px;
                                border-radius: 2px;
                            }
                        `;
                    } else {
                        // è§†é¢‘æ ·å¼ä¼˜åŒ–
                        style.textContent = `
                            body { 
                                margin: 0; 
                                padding: 0; 
                                background: #000;
                                overflow: hidden;
                            }
                            video {
                                width: 100%;
                                height: 100%;
                                object-fit: cover;
                            }
                            .video-controls {
                                position: absolute;
                                bottom: 10px;
                                left: 50%;
                                transform: translateX(-50%);
                                background: rgba(0,0,0,0.7);
                                padding: 5px 10px;
                                border-radius: 4px;
                                color: white;
                                font-size: 12px;
                            }
                        `;
                    }
                    
                    iframeDoc.head.appendChild(style);
                    console.log(`ğŸ“ ${type} iframeæ ·å¼ä¼˜åŒ–å®Œæˆ`);
                    
                } catch (e) {
                    console.log(`âš ï¸ æ— æ³•ä¼˜åŒ–${type} iframeå†…å®¹ (è·¨åŸŸé™åˆ¶):`, e.message);
                }
            },
            
            // æ˜¾ç¤ºiframeé”™è¯¯
            showIframeError: function(container, url, type) {
                const errorContent = `
                    <div style="display: flex; flex-direction: column; justify-content: center; 
                                align-items: center; height: 100%; background: ${type === this.IFRAME_TYPES.ROADMAP ? '#f5f5f5' : '#1a1a1a'}; 
                                color: ${type === this.IFRAME_TYPES.ROADMAP ? '#333' : '#fff'}; text-align: center; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">
                            ${type === this.IFRAME_TYPES.ROADMAP ? 'ğŸ“Š' : 'ğŸ“¹'}
                        </div>
                        <h4 style="margin-bottom: 8px;">
                            ${type === this.IFRAME_TYPES.ROADMAP ? 'è·¯å•åŠ è½½å¤±è´¥' : 'è§†é¢‘åŠ è½½å¤±è´¥'}
                        </h4>
                        <p style="margin-bottom: 15px; opacity: 0.7; font-size: 12px;">
                            æ— æ³•è¿æ¥åˆ°: ${url.length > 50 ? url.substring(0, 50) + '...' : url}
                        </p>
                        <button onclick="window.BaccaratIframeManager.retryLoad('${container.id}', '${url}')" 
                                style="background: #007bff; color: white; border: none; 
                                       padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            é‡æ–°åŠ è½½
                        </button>
                    </div>
                `;
                container.innerHTML = errorContent;
            },
            
            // é‡è¯•åŠ è½½
            retryLoad: function(containerId, url) {
                console.log('ğŸ”„ é‡è¯•åŠ è½½iframe:', containerId, url);
                // æ‰¾åˆ°å¯¹åº”çš„å®¹å™¨IDè¿›è¡Œé‡æ–°åˆ›å»º
                for (const [id, data] of this.containers.entries()) {
                    if (data.container.id === containerId) {
                        return this.createIframe(id, url);
                    }
                }
                return false;
            },
            
            // è®¾ç½®å¯è§æ€§
            setVisibility: function(containerId, visible) {
                const containerData = this.containers.get(containerId);
                if (containerData) {
                    containerData.container.style.display = visible ? 'block' : 'none';
                    console.log(`ğŸ”„ ${containerData.type} å¯è§æ€§:`, visible ? 'æ˜¾ç¤º' : 'éšè—');
                    return true;
                }
                return false;
            },
            
            // åˆ·æ–°iframe
            refresh: function(containerId) {
                const containerData = this.containers.get(containerId);
                if (containerData) {
                    const currentSrc = containerData.iframe.src;
                    containerData.iframe.src = '';
                    setTimeout(() => {
                        containerData.iframe.src = currentSrc;
                    }, 100);
                    console.log(`ğŸ”„ ${containerData.type} åˆ·æ–°å®Œæˆ`);
                    return true;
                }
                return false;
            },
            
            // é”€æ¯iframe
            destroyIframe: function(containerId) {
                const containerData = this.containers.get(containerId);
                if (containerData) {
                    containerData.container.innerHTML = '';
                    containerData.container.style.display = 'none';
                    this.containers.delete(containerId);
                    console.log(`ğŸ—‘ï¸ ${containerData.type} iframeå·²é”€æ¯`);
                    return true;
                }
                return false;
            },
            
            // åˆ‡æ¢è§†é¢‘æºï¼ˆè¿œæ™¯/è¿‘æ™¯ï¼‰
            switchVideoSource: function(toFar = true) {
                const farContainer = document.getElementById('video-far-container');
                const nearContainer = document.getElementById('video-near-container');
                
                if (toFar) {
                    farContainer.style.display = 'block';
                    nearContainer.style.display = 'none';
                    console.log('ğŸ“¹ åˆ‡æ¢åˆ°è¿œæ™¯è§†é¢‘');
                } else {
                    farContainer.style.display = 'none';
                    nearContainer.style.display = 'block';
                    console.log('ğŸ“¹ åˆ‡æ¢åˆ°è¿‘æ™¯è§†é¢‘');
                }
            }
        };
        
        // Unityè°ƒç”¨æ¥å£
        window.loadIframe = function(containerIdAndUrl) {
            const parts = containerIdAndUrl.split(',');
            const containerId = parts[0];
            const url = parts.slice(1).join(',');
            return window.BaccaratIframeManager.createIframe(containerId, url);
        };
        
        window.setIframeVisibility = function(containerIdAndVisibility) {
            const parts = containerIdAndVisibility.split(',');
            const containerId = parts[0];
            const visible = parts[1] === '1';
            return window.BaccaratIframeManager.setVisibility(containerId, visible);
        };
        
        window.refreshIframe = function(containerId) {
            return window.BaccaratIframeManager.refresh(containerId);
        };
        
        window.destroyIframe = function(containerId) {
            return window.BaccaratIframeManager.destroyIframe(containerId);
        };
        
        // åˆ‡æ¢è§†é¢‘æºçš„å…¨å±€å‡½æ•°
        window.switchVideoSource = function(toFar) {
            return window.BaccaratIframeManager.switchVideoSource(toFar);
        };
        
        console.log('ğŸ° ç™¾å®¶ä¹iframeç®¡ç†å™¨å·²åŠ è½½');
    </script>
    
    <!-- åŠ è½½ç®¡ç†å™¨ -->
    <script>
        // è¯¦ç»†åŠ è½½ç®¡ç†å™¨
        window.LoadingManager = {
            startTime: Date.now(),
            steps: [
                { id: 'step-env', name: 'ç¯å¢ƒæ£€æµ‹', duration: 500 },
                { id: 'step-webgl', name: 'WebGLåˆå§‹åŒ–', duration: 800 },
                { id: 'step-loader', name: 'Unity Loader', duration: 2000 },
                { id: 'step-framework', name: 'FrameworkåŠ è½½', duration: 3000 },
                { id: 'step-assets', name: 'èµ„æºä¸‹è½½', duration: 0 }, // åŠ¨æ€è®¡ç®—
                { id: 'step-complete', name: 'å¯åŠ¨å®Œæˆ', duration: 500 }
            ],
            currentStepIndex: 0,
            totalProgress: 0,
            
            // æ–‡ä»¶å¤§å°ä¼°ç®— (KB)
            fileSizes: {
                loader: 57,
                framework: 892,
                wasm: 158119,
                data: 21416
            },
            
            init: function() {
                // è®¡ç®—æ€»æ–‡ä»¶å¤§å°
                const totalSize = Object.values(this.fileSizes).reduce((a, b) => a + b, 0);
                document.getElementById('estimated-size').textContent = this.formatBytes(totalSize * 1024);
                
                // å¼€å§‹ç¬¬ä¸€æ­¥
                this.nextStep();
            },
            
            nextStep: function() {
                if (this.currentStepIndex < this.steps.length) {
                    const step = this.steps[this.currentStepIndex];
                    this.activateStep(step.id);
                    this.currentStepIndex++;
                }
            },
            
            activateStep: function(stepId) {
                // æ ‡è®°å‰é¢çš„æ­¥éª¤ä¸ºå®Œæˆ
                for (let i = 0; i < this.currentStepIndex; i++) {
                    const prevStep = document.getElementById(this.steps[i].id);
                    if (prevStep) {
                        prevStep.className = 'loading-step completed';
                        prevStep.querySelector('.step-icon').textContent = 'âœ…';
                    }
                }
                
                // æ¿€æ´»å½“å‰æ­¥éª¤
                const currentStep = document.getElementById(stepId);
                if (currentStep) {
                    currentStep.className = 'loading-step active';
                    currentStep.querySelector('.step-icon').textContent = 'â³';
                }
                
                // æ›´æ–°çŠ¶æ€æ–‡æœ¬
                const stepName = this.steps.find(s => s.id === stepId)?.name || 'å¤„ç†ä¸­';
                document.getElementById('progress-status').textContent = stepName + '...';
            },
            
            updateProgress: function(progress, status = '') {
                this.totalProgress = Math.max(this.totalProgress, progress);
                
                document.getElementById('progress-fill').style.width = this.totalProgress + '%';
                document.getElementById('progress-percent').textContent = Math.round(this.totalProgress) + '%';
                
                if (status) {
                    document.getElementById('progress-status').textContent = status;
                }
                
                // æ˜¾ç¤ºæ—¶é—´ä¼°ç®—
                this.updateTimeEstimate();
            },
            
            updateTimeEstimate: function() {
                const elapsed = Date.now() - this.startTime;
                const estimateDiv = document.getElementById('time-estimate');
                
                if (this.totalProgress > 10) {
                    const totalEstimated = (elapsed / this.totalProgress) * 100;
                    const remaining = Math.max(0, totalEstimated - elapsed);
                    
                    document.getElementById('time-remaining').textContent = this.formatTime(remaining);
                    estimateDiv.style.display = 'block';
                }
            },
            
            complete: function() {
                // æ ‡è®°æ‰€æœ‰æ­¥éª¤å®Œæˆ
                this.steps.forEach(step => {
                    const stepEl = document.getElementById(step.id);
                    if (stepEl) {
                        stepEl.className = 'loading-step completed';
                        stepEl.querySelector('.step-icon').textContent = 'âœ…';
                    }
                });
                
                this.updateProgress(100, 'æ¸¸æˆå‡†å¤‡å®Œæˆ');
                
                // å»¶è¿Ÿéšè—åŠ è½½ç•Œé¢
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    document.getElementById('game-container').style.display = 'block';
                }, 1000);
            },
            
            error: function(message) {
                const currentStep = document.getElementById(this.steps[Math.max(0, this.currentStepIndex - 1)].id);
                if (currentStep) {
                    currentStep.className = 'loading-step error';
                    currentStep.querySelector('.step-icon').textContent = 'âŒ';
                }
                
                document.getElementById('progress-status').textContent = 'åŠ è½½å¤±è´¥';
                document.getElementById('error-message').textContent = message;
                
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    document.getElementById('error-overlay').style.display = 'flex';
                }, 1000);
            },
            
            formatBytes: function(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            },
            
            formatTime: function(ms) {
                const seconds = Math.ceil(ms / 1000);
                if (seconds < 60) return seconds + ' ç§’';
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return minutes + ' åˆ† ' + remainingSeconds + ' ç§’';
            }
        };
    </script>
    
    <!-- ä¸»åˆå§‹åŒ–è„šæœ¬ -->
    <script>
        // å…¨å±€å˜é‡
        let unityInstance = null;
        let compatibilityMode = false;
        
        // DOMå…ƒç´ 
        const canvas = document.querySelector("#unity-canvas");
        
        // Canvasåˆå§‹åŒ–
        function initializeCanvas() {
            DeviceCompatibilityManager.detectEnvironment();
            
            const targetWidth = parseInt('{{{ WIDTH }}}') || 750;
            const targetHeight = parseInt('{{{ HEIGHT }}}') || 1344;
            
            const optimalSize = DeviceCompatibilityManager.getOptimalCanvasSize(targetWidth, targetHeight);
            
            canvas.width = optimalSize.width;
            canvas.height = optimalSize.height;
            
            // UnityåŒºåŸŸè‡ªé€‚åº”ï¼ŒCanvasä¼šè‡ªåŠ¨ç¼©æ”¾
            canvas.style.maxWidth = '100%';
            canvas.style.maxHeight = '100%';
            canvas.style.objectFit = 'contain';
            
            console.log(`âœ… Canvasåˆå§‹åŒ–: ${optimalSize.width}x${optimalSize.height}`);
            return optimalSize;
        }
        
        // ç­‰å¾…Unity Loader
        function waitForUnityLoader() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 200;
                
                const checkLoader = () => {
                    attempts++;
                    
                    if (window.UnityLoader || typeof createUnityInstance !== 'undefined') {
                        console.log('âœ… Unity Loaderå‡†å¤‡å°±ç»ª');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('Unity LoaderåŠ è½½è¶…æ—¶'));
                    } else {
                        setTimeout(checkLoader, 100);
                    }
                };
                
                checkLoader();
            });
        }
        
        // ç­‰å¾…createUnityInstance
        function waitForCreateUnityInstance() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 200;
                
                const checkFunction = () => {
                    attempts++;
                    
                    if (typeof createUnityInstance !== 'undefined') {
                        console.log('âœ… createUnityInstanceå‡½æ•°å°±ç»ª');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('createUnityInstanceå‡½æ•°åŠ è½½è¶…æ—¶'));
                    } else {
                        setTimeout(checkFunction, 100);
                    }
                };
                
                checkFunction();
            });
        }
        
        // Unityèµ„æºåŠ è½½è¿›åº¦å›è°ƒ
        function updateUnityProgress(progress) {
            const baseProgress = 60; // å‰é¢æ­¥éª¤å 60%
            const unityProgress = baseProgress + (progress * 35); // Unityèµ„æºåŠ è½½å 35%
            
            LoadingManager.updateProgress(unityProgress, `ä¸‹è½½æ¸¸æˆèµ„æº ${Math.round(progress * 100)}%`);
        }
        
        // é”™è¯¯å¤„ç†
        function onUnityError(error) {
            console.error("Unityé”™è¯¯:", error);
            LoadingManager.error(error.toString());
        }
        
        // Unityåˆå§‹åŒ–ä¸»æµç¨‹
        async function initializeUnity() {
            try {
                console.log('ğŸš€ å¼€å§‹Unityåˆå§‹åŒ–...');
                
                // æ­¥éª¤1: ç¯å¢ƒæ£€æµ‹ (0-10%)
                LoadingManager.updateProgress(5, 'æ£€æµ‹è®¾å¤‡ç¯å¢ƒ...');
                const canvasSize = initializeCanvas();
                await new Promise(resolve => setTimeout(resolve, 500));
                LoadingManager.nextStep();
                LoadingManager.updateProgress(10, 'ç¯å¢ƒæ£€æµ‹å®Œæˆ');
                
                // æ­¥éª¤2: WebGLåˆå§‹åŒ– (10-20%)
                LoadingManager.updateProgress(15, 'åˆå§‹åŒ–WebGLå¼•æ“...');
                await new Promise(resolve => setTimeout(resolve, 800));
                LoadingManager.nextStep();
                LoadingManager.updateProgress(20, 'WebGLå¼•æ“å°±ç»ª');
                
                // æ­¥éª¤3: Unity Loader (20-35%)
                LoadingManager.updateProgress(25, 'åŠ è½½Unityæ ¸å¿ƒæ¨¡å—...');
                await waitForUnityLoader();
                LoadingManager.nextStep();
                LoadingManager.updateProgress(35, 'Unityæ ¸å¿ƒæ¨¡å—å°±ç»ª');
                
                // æ­¥éª¤4: Framework (35-60%)
                LoadingManager.updateProgress(40, 'åˆå§‹åŒ–æ¸¸æˆæ¡†æ¶...');
                await waitForCreateUnityInstance();
                LoadingManager.nextStep();
                LoadingManager.updateProgress(60, 'æ¸¸æˆæ¡†æ¶åˆå§‹åŒ–å®Œæˆ');
                
                // æ­¥éª¤5: åˆ›å»ºUnityå®ä¾‹å’Œèµ„æºåŠ è½½ (60-95%)
                LoadingManager.updateProgress(65, 'åˆ›å»ºæ¸¸æˆå®ä¾‹...');
                window.gameConfig = DeviceCompatibilityManager.getOptimizedUnityConfig();
                
                unityInstance = await createUnityInstance(canvas, window.gameConfig, updateUnityProgress);
                window.unityInstance = unityInstance;
                LoadingManager.nextStep();
                
                // æ­¥éª¤6: å®Œæˆ (95-100%)
                LoadingManager.updateProgress(98, 'å¯åŠ¨æ¸¸æˆ...');
                
                // åˆå§‹åŒ–æ¸¸æˆæ¡¥æ¥
                if (window.unityBridge) {
                    window.unityBridge.initialize(unityInstance);
                }
                
                // å‘é€å°±ç»ªäº‹ä»¶
                window.dispatchEvent(new Event('unity-ready'));
                
                LoadingManager.nextStep();
                LoadingManager.complete();
                
                console.log("âœ… Unityç™¾å®¶ä¹æ¸¸æˆåˆå§‹åŒ–å®Œæˆ!");
                
                // å‘é€URLå‚æ•°
                setTimeout(() => {
                    sendUrlParametersToUnity();
                }, 1000);
                
            } catch (error) {
                console.error("âŒ Unityåˆå§‹åŒ–å¤±è´¥:", error);
                onUnityError(error);
            }
        }
        
        // å‘é€URLå‚æ•°åˆ°Unity
        function sendUrlParametersToUnity() {
            if (unityInstance) {
                try {
                    const params = new URLSearchParams(window.location.search);
                    const gameParams = {};
                    
                    ['table_id', 'game_type', 'user_id', 'token', 'language', 'currency', 'room_id'].forEach(name => {
                        if (params.has(name)) {
                            gameParams[name] = params.get(name);
                        }
                    });
                    
                    if (Object.keys(gameParams).length > 0) {
                        console.log('ğŸ“¤ å‘é€URLå‚æ•°åˆ°Unity:', gameParams);
                        unityInstance.SendMessage('GameManager', 'SetUrlParameters', JSON.stringify(gameParams));
                    }
                } catch (error) {
                    console.warn('âš ï¸ å‘é€URLå‚æ•°å¤±è´¥:', error);
                }
            }
        }
        
        // å·¥å…·å‡½æ•°
        function toggleCompatibilityMode() {
            compatibilityMode = !compatibilityMode;
            localStorage.setItem('baccarat-compatibility-mode', compatibilityMode.toString());
            window.location.reload();
        }
        
        function contactSupport() {
            // è¿™é‡Œå¯ä»¥æ·»åŠ å®¢æœè”ç³»é€»è¾‘
            alert('è¯·è”ç³»å®¢æœè·å–æŠ€æœ¯æ”¯æŒ\n\nå®¢æœQQ: 123456789\nå®¢æœå¾®ä¿¡: support123');
        }
        
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ° ç™¾å®¶ä¹æ¸¸æˆé¡µé¢åŠ è½½å®Œæˆ');
            
            // æ£€æŸ¥å…¼å®¹æ€§æ¨¡å¼
            const savedCompatMode = localStorage.getItem('baccarat-compatibility-mode');
            if (savedCompatMode === 'true') {
                compatibilityMode = true;
            }
            
            // åˆå§‹åŒ–è¾…åŠ©è„šæœ¬
            if (window.safariCompatibility) {
                window.safariCompatibility.initialize();
            }
            
            if (window.errorHandler) {
                window.errorHandler.initialize();
            }
            
            // åˆå§‹åŒ–åŠ è½½ç®¡ç†å™¨
            LoadingManager.init();
            
            // å¼€å§‹Unityåˆå§‹åŒ–
            setTimeout(() => {
                initializeUnity();
            }, 1000);
        });
        
        // é¡µé¢å¸è½½æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (unityInstance) {
                try {
                    unityInstance.Quit();
                } catch (e) {
                    console.warn('Unityé€€å‡ºè­¦å‘Š:', e);
                }
            }
        });
        
        console.log('ğŸ° ç™¾å®¶ä¹æ¸¸æˆ - ä¸“ä¸šç‰ˆæœ¬å·²åŠ è½½');
    </script>

</body>
</html>