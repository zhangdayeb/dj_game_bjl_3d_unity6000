<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <title>百家乐游戏</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="专业的在线百家乐游戏平台，支持实时视频直播和多种投注玩法">
    <meta name="keywords" content="百家乐,在线游戏,真人娱乐,WebGL游戏">
    <meta name="author" content="Baccarat Game Team">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="百家乐游戏">
    <meta property="og:description" content="专业的在线百家乐游戏平台">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{{ UNITY_CUSTOM_WEBSITE_URL }}}">
    <meta property="og:image" content="TemplateData/og-image.jpg">
    
    <!-- Favicon -->
    <link rel="icon" href="Assets/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="Assets/favicon.ico" type="image/x-icon">
    
    <!-- Preload Critical Resources -->
    <link rel="preload" href="TemplateData/style.css" as="style">
    <link rel="preload" href="Build/{{{ LOADER_FILENAME }}}" as="script">
    <link rel="preload" href="Build/{{{ FRAMEWORK_FILENAME }}}" as="script">
    <link rel="prefetch" href="Build/{{{ CODE_FILENAME }}}" as="fetch" crossorigin>
    <link rel="prefetch" href="Build/{{{ DATA_FILENAME }}}" as="fetch" crossorigin>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="TemplateData/style.css">
    
    <!-- 自定义样式 -->
    <style>
        /* 全局样式重置 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            background: #000;
            overflow: hidden;
            user-select: none;
        }
        
        /* 加载界面样式 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-content {
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        
        .loading-logo {
            font-size: 48px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        .loading-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .loading-subtitle {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 30px;
        }
        
        /* 详细加载步骤 */
        .loading-steps {
            margin-bottom: 30px;
            text-align: left;
        }
        
        .loading-step {
            display: flex;
            align-items: center;
            padding: 8px 0;
            font-size: 14px;
            opacity: 0.6;
            transition: all 0.3s ease;
        }
        
        .loading-step.active {
            opacity: 1;
            color: #4CAF50;
        }
        
        .loading-step.completed {
            opacity: 1;
            color: #4CAF50;
        }
        
        .loading-step.error {
            opacity: 1;
            color: #f44336;
        }
        
        .step-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 进度条 */
        .progress-container {
            width: 100%;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #2196F3);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            margin-top: 10px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .file-size-info {
            opacity: 0.7;
            font-size: 11px;
        }
        
        /* 时间估算 */
        .time-estimate {
            margin-top: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            font-size: 12px;
        }
        
        .time-estimate .label {
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .time-estimate .value {
            font-weight: bold;
            color: #4CAF50;
        }
        
        /* 游戏主界面 */
        .game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: none;
        }
        
        .game-layout {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* 视频区域 - 顶部固定 */
        .video-section {
            position: relative;
            height: 40vh;
            min-height: 300px;
            background: #1a1a1a;
            border-bottom: 2px solid #333;
        }
        
        /* Unity游戏区域 - 中间自适应 */
        .unity-section {
            flex: 1;
            position: relative;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 0; /* 重要：允许flex收缩 */
        }
        
        #unity-canvas {
            width: 100% !important;
            height: 100% !important;
            max-width: 100%;
            max-height: 100%;
            border-radius: 0;
            object-fit: contain;
            display: block;
        }
        
        /* 路单区域 - 底部固定 */
        .roadmap-section {
            position: relative;
            height: 25vh;
            min-height: 200px;
            background: #2a2a2a;
            border-top: 2px solid #333;
        }
        
        /* iframe 基础样式 */
        .iframe-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
        }
        
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
        
        /* 视频iframe样式 */
        .video-iframe-container {
            background: #000;
        }
        
        .video-iframe-container iframe {
            background: #000;
        }
        
        /* 路单iframe样式 */
        .roadmap-iframe-container {
            background: #f5f5f5;
        }
        
        .roadmap-iframe-container iframe {
            background: #f5f5f5;
        }
        
        /* 区域标签 */
        .section-label {
            position: absolute;
            top: 5px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            z-index: 100;
            pointer-events: none;
        }
        
        /* 错误界面 */
        .error-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #c62828 0%, #d32f2f 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10000;
            text-align: center;
            padding: 20px;
        }
        
        .error-content h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .error-content p {
            margin-bottom: 20px;
            opacity: 0.9;
            line-height: 1.5;
        }
        
        .error-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        /* 动画效果 */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-step.active {
            animation: fadeIn 0.3s ease;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .video-section {
                height: 35vh;
                min-height: 250px;
            }
            
            .roadmap-section {
                height: 20vh;
                min-height: 150px;
            }
            
            .loading-title {
                font-size: 20px;
            }
            
            .loading-logo {
                font-size: 36px;
            }
        }
        
        @media (max-width: 480px) {
            .video-section {
                height: 30vh;
                min-height: 200px;
            }
            
            .roadmap-section {
                height: 18vh;
                min-height: 120px;
            }
        }
    </style>
    
    <!-- 兼容性检测脚本 -->
    <script>
        // 设备兼容性管理器
        window.DeviceCompatibilityManager = {
            isSimulator: false,
            isMobile: false,
            maxTextureSize: 0,
            
            detectEnvironment: function() {
                const userAgent = navigator.userAgent;
                
                // 检测模拟器
                this.isSimulator = window.navigator.webdriver || 
                                  window.outerHeight === 0 || 
                                  window.outerWidth === 0 ||
                                  userAgent.includes('HeadlessChrome') ||
                                  (window.chrome && window.chrome.runtime);
                
                // 检测移动设备
                this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
                
                return { isSimulator: this.isSimulator, isMobile: this.isMobile };
            },
            
            getWebGLCapabilities: function() {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    
                    if (gl) {
                        this.maxTextureSize = gl.getParameter(gl.MAX_TEXTURE_SIZE);
                        return {
                            maxTextureSize: this.maxTextureSize,
                            renderer: gl.getParameter(gl.getExtension('WEBGL_debug_renderer_info')?.UNMASKED_RENDERER_WEBGL) || 'Unknown'
                        };
                    }
                } catch (e) {
                    console.error('WebGL检测失败:', e);
                }
                return null;
            },
            
            getOptimalCanvasSize: function(targetWidth, targetHeight) {
                const capabilities = this.getWebGLCapabilities();
                if (!capabilities) return { width: 400, height: 600 };
                
                let maxSafeSize;
                if (this.isSimulator) {
                    maxSafeSize = Math.min(capabilities.maxTextureSize, 512);
                } else if (this.isMobile) {
                    maxSafeSize = Math.min(capabilities.maxTextureSize, 1024);
                } else {
                    maxSafeSize = Math.min(capabilities.maxTextureSize, 2048);
                }
                
                const aspectRatio = targetWidth / targetHeight;
                let safeWidth, safeHeight;
                
                if (aspectRatio > 1) {
                    safeWidth = Math.min(targetWidth, maxSafeSize);
                    safeHeight = Math.round(safeWidth / aspectRatio);
                } else {
                    safeHeight = Math.min(targetHeight, maxSafeSize);
                    safeWidth = Math.round(safeHeight * aspectRatio);
                }
                
                return { 
                    width: Math.min(safeWidth, maxSafeSize), 
                    height: Math.min(safeHeight, maxSafeSize) 
                };
            },
            
            getOptimizedUnityConfig: function() {
                return {
                    dataUrl: "Build/{{{ DATA_FILENAME }}}",
                    frameworkUrl: "Build/{{{ FRAMEWORK_FILENAME }}}",
                    codeUrl: "Build/{{{ CODE_FILENAME }}}",
                    streamingAssetsUrl: "StreamingAssets",
                    companyName: "{{{ COMPANY_NAME }}}",
                    productName: "{{{ PRODUCT_NAME }}}",
                    productVersion: "{{{ PRODUCT_VERSION }}}",
                    devicePixelRatio: this.isSimulator ? 1 : Math.min(window.devicePixelRatio || 1, 2)
                };
            }
        };
        
        // WebGL支持检测
        function checkWebGLSupport() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                return !!gl;
            } catch(e) {
                return false;
            }
        }
        
        if (!checkWebGLSupport()) {
            document.addEventListener('DOMContentLoaded', function() {
                document.body.innerHTML = `
                    <div class="error-overlay" style="display: flex;">
                        <div class="error-content">
                            <h2>🚫 WebGL 不支持</h2>
                            <p>您的浏览器不支持WebGL，无法运行游戏</p>
                            <p><strong>推荐浏览器：</strong> Chrome、Firefox、Safari、Edge</p>
                            <div class="error-actions">
                                <button onclick="window.location.reload()">重新检测</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
    </script>
</head>

<body>
    <!-- 详细加载界面 -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <!-- Logo和标题 -->
            <div class="loading-logo">🎰</div>
            <div class="loading-title">百家乐游戏</div>
            <div class="loading-subtitle">正在加载游戏引擎和资源文件...</div>
            
            <!-- 加载步骤 -->
            <div class="loading-steps">
                <div class="loading-step" id="step-env">
                    <div class="step-icon">🔍</div>
                    <div>检测设备环境和兼容性</div>
                </div>
                <div class="loading-step" id="step-webgl">
                    <div class="step-icon">🎮</div>
                    <div>初始化WebGL渲染引擎</div>
                </div>
                <div class="loading-step" id="step-loader">
                    <div class="step-icon">📦</div>
                    <div>加载Unity核心模块</div>
                </div>
                <div class="loading-step" id="step-framework">
                    <div class="step-icon">⚙️</div>
                    <div>初始化游戏框架</div>
                </div>
                <div class="loading-step" id="step-assets">
                    <div class="step-icon">🎨</div>
                    <div>下载游戏资源文件</div>
                </div>
                <div class="loading-step" id="step-complete">
                    <div class="step-icon">✅</div>
                    <div>启动游戏实例</div>
                </div>
            </div>
            
            <!-- 进度条 -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text">
                    <span id="progress-status">准备中...</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div class="file-size-info" id="file-size-info">
                    预计下载: <span id="estimated-size">计算中...</span>
                </div>
            </div>
            
            <!-- 时间估算 -->
            <div class="time-estimate" id="time-estimate" style="display: none;">
                <div class="label">预计剩余时间</div>
                <div class="value" id="time-remaining">计算中...</div>
            </div>
        </div>
    </div>
    
    <!-- 游戏主界面 -->
    <div class="game-container" id="game-container">
        <div class="game-layout">
            <!-- 视频区域 - 顶部 -->
            <div class="video-section">
                <div class="section-label">视频直播区</div>
                <!-- 远景视频 -->
                <div id="video-far-container" class="iframe-container video-iframe-container" style="display: none;">
                    <!-- iframe will be inserted here -->
                </div>
                <!-- 近景视频 -->
                <div id="video-near-container" class="iframe-container video-iframe-container" style="display: none;">
                    <!-- iframe will be inserted here -->
                </div>
            </div>
            
            <!-- Unity游戏区域 - 中间 -->
            <div class="unity-section">
                <canvas id="unity-canvas" tabindex="-1"></canvas>
            </div>
            
            <!-- 路单区域 - 底部 -->
            <div class="roadmap-section">
                <div class="section-label">游戏路单</div>
                <div id="roadmap-container" class="iframe-container roadmap-iframe-container" style="display: none;">
                    <!-- iframe will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 错误界面 -->
    <div class="error-overlay" id="error-overlay">
        <div class="error-content">
            <h2>🚫 加载失败</h2>
            <p id="error-message">游戏加载过程中发生错误</p>
            <div class="error-actions">
                <button onclick="window.location.reload()">🔄 重新加载</button>
                <button onclick="toggleCompatibilityMode()">🛠️ 兼容模式</button>
                <button onclick="contactSupport()">📞 联系客服</button>
            </div>
        </div>
    </div>
    
    <!-- Unity脚本 -->
    <script src="Build/{{{ LOADER_FILENAME }}}"></script>
    
    <!-- 辅助脚本 -->
    <script src="TemplateData/unity-bridge.js"></script>
    <script src="TemplateData/safari-compatibility.js"></script>
    <script src="TemplateData/error-handler.js"></script>
    
    <!-- 百家乐专用iframe管理器 -->
    <script>
        // 百家乐iframe管理器
        window.BaccaratIframeManager = {
            containers: new Map(),
            
            // iframe类型定义
            IFRAME_TYPES: {
                VIDEO_FAR: 'video-far',      // 远景视频
                VIDEO_NEAR: 'video-near',    // 近景视频  
                ROADMAP: 'roadmap'           // 路单
            },
            
            // 创建iframe
            createIframe: function(containerId, url) {
                try {
                    console.log('🎯 创建百家乐iframe:', containerId, url);
                    
                    // 确定iframe类型和目标容器
                    let targetContainer, iframeType;
                    
                    if (containerId.includes('video') || containerId.includes('camera')) {
                        // 视频iframe - 检查是远景还是近景
                        if (containerId.includes('far') || containerId.includes('wide') || containerId.includes('overview')) {
                            targetContainer = document.getElementById('video-far-container');
                            iframeType = this.IFRAME_TYPES.VIDEO_FAR;
                        } else {
                            targetContainer = document.getElementById('video-near-container');
                            iframeType = this.IFRAME_TYPES.VIDEO_NEAR;
                        }
                    } else if (containerId.includes('roadmap') || containerId.includes('road') || containerId.includes('history')) {
                        // 路单iframe
                        targetContainer = document.getElementById('roadmap-container');
                        iframeType = this.IFRAME_TYPES.ROADMAP;
                    } else {
                        // 默认为近景视频
                        targetContainer = document.getElementById('video-near-container');
                        iframeType = this.IFRAME_TYPES.VIDEO_NEAR;
                    }
                    
                    if (!targetContainer) {
                        console.error('❌ 未找到目标容器:', containerId);
                        return false;
                    }
                    
                    // 清理现有内容
                    targetContainer.innerHTML = '';
                    
                    // 创建iframe
                    const iframe = document.createElement('iframe');
                    iframe.src = url;
                    iframe.style.cssText = `
                        width: 100%;
                        height: 100%;
                        border: none;
                        display: block;
                    `;
                    
                    // 根据类型设置iframe属性
                    if (iframeType === this.IFRAME_TYPES.ROADMAP) {
                        // 路单iframe配置
                        iframe.setAttribute('scrolling', 'auto');
                        iframe.setAttribute('sandbox', 'allow-same-origin allow-scripts allow-forms');
                        iframe.style.background = '#f5f5f5';
                    } else {
                        // 视频iframe配置
                        iframe.setAttribute('allowfullscreen', 'true');
                        iframe.setAttribute('scrolling', 'no');
                        iframe.setAttribute('allow', 'autoplay; fullscreen; camera; microphone');
                        iframe.setAttribute('sandbox', 'allow-same-origin allow-scripts allow-forms allow-presentation');
                        iframe.style.background = '#000';
                    }
                    
                    iframe.setAttribute('frameborder', '0');
                    
                    // iframe事件处理
                    iframe.onload = () => {
                        console.log(`✅ ${iframeType} iframe加载完成:`, url);
                        
                        // 尝试优化iframe内容
                        this.optimizeIframeContent(iframe, iframeType);
                    };
                    
                    iframe.onerror = (error) => {
                        console.error(`❌ ${iframeType} iframe加载失败:`, error);
                        this.showIframeError(targetContainer, url, iframeType);
                    };
                    
                    // 添加到容器
                    targetContainer.appendChild(iframe);
                    targetContainer.style.display = 'block';
                    
                    // 保存引用
                    this.containers.set(containerId, {
                        container: targetContainer,
                        iframe: iframe,
                        url: url,
                        type: iframeType
                    });
                    
                    console.log(`✅ ${iframeType} iframe创建成功:`, containerId);
                    return true;
                    
                } catch (error) {
                    console.error('❌ iframe创建失败:', error);
                    return false;
                }
            },
            
            // 优化iframe内容
            optimizeIframeContent: function(iframe, type) {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (!iframeDoc) return;
                    
                    const style = iframeDoc.createElement('style');
                    
                    if (type === this.IFRAME_TYPES.ROADMAP) {
                        // 路单样式优化
                        style.textContent = `
                            body { 
                                margin: 0; 
                                padding: 8px; 
                                font-family: Arial, sans-serif;
                                background: #f8f9fa;
                                overflow-x: auto;
                                font-size: 12px;
                            }
                            table { 
                                width: 100%; 
                                border-collapse: collapse; 
                                margin-bottom: 10px;
                            }
                            th, td { 
                                padding: 4px 6px; 
                                border: 1px solid #ddd; 
                                text-align: center;
                                font-size: 11px;
                            }
                            th { 
                                background: #e9ecef; 
                                font-weight: bold;
                            }
                            .roadmap-grid {
                                display: grid;
                                gap: 2px;
                                padding: 4px;
                            }
                            .road-item {
                                min-height: 20px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 10px;
                                border-radius: 2px;
                            }
                        `;
                    } else {
                        // 视频样式优化
                        style.textContent = `
                            body { 
                                margin: 0; 
                                padding: 0; 
                                background: #000;
                                overflow: hidden;
                            }
                            video {
                                width: 100%;
                                height: 100%;
                                object-fit: cover;
                            }
                            .video-controls {
                                position: absolute;
                                bottom: 10px;
                                left: 50%;
                                transform: translateX(-50%);
                                background: rgba(0,0,0,0.7);
                                padding: 5px 10px;
                                border-radius: 4px;
                                color: white;
                                font-size: 12px;
                            }
                        `;
                    }
                    
                    iframeDoc.head.appendChild(style);
                    console.log(`📝 ${type} iframe样式优化完成`);
                    
                } catch (e) {
                    console.log(`⚠️ 无法优化${type} iframe内容 (跨域限制):`, e.message);
                }
            },
            
            // 显示iframe错误
            showIframeError: function(container, url, type) {
                const errorContent = `
                    <div style="display: flex; flex-direction: column; justify-content: center; 
                                align-items: center; height: 100%; background: ${type === this.IFRAME_TYPES.ROADMAP ? '#f5f5f5' : '#1a1a1a'}; 
                                color: ${type === this.IFRAME_TYPES.ROADMAP ? '#333' : '#fff'}; text-align: center; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">
                            ${type === this.IFRAME_TYPES.ROADMAP ? '📊' : '📹'}
                        </div>
                        <h4 style="margin-bottom: 8px;">
                            ${type === this.IFRAME_TYPES.ROADMAP ? '路单加载失败' : '视频加载失败'}
                        </h4>
                        <p style="margin-bottom: 15px; opacity: 0.7; font-size: 12px;">
                            无法连接到: ${url.length > 50 ? url.substring(0, 50) + '...' : url}
                        </p>
                        <button onclick="window.BaccaratIframeManager.retryLoad('${container.id}', '${url}')" 
                                style="background: #007bff; color: white; border: none; 
                                       padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            重新加载
                        </button>
                    </div>
                `;
                container.innerHTML = errorContent;
            },
            
            // 重试加载
            retryLoad: function(containerId, url) {
                console.log('🔄 重试加载iframe:', containerId, url);
                // 找到对应的容器ID进行重新创建
                for (const [id, data] of this.containers.entries()) {
                    if (data.container.id === containerId) {
                        return this.createIframe(id, url);
                    }
                }
                return false;
            },
            
            // 设置可见性
            setVisibility: function(containerId, visible) {
                const containerData = this.containers.get(containerId);
                if (containerData) {
                    containerData.container.style.display = visible ? 'block' : 'none';
                    console.log(`🔄 ${containerData.type} 可见性:`, visible ? '显示' : '隐藏');
                    return true;
                }
                return false;
            },
            
            // 刷新iframe
            refresh: function(containerId) {
                const containerData = this.containers.get(containerId);
                if (containerData) {
                    const currentSrc = containerData.iframe.src;
                    containerData.iframe.src = '';
                    setTimeout(() => {
                        containerData.iframe.src = currentSrc;
                    }, 100);
                    console.log(`🔄 ${containerData.type} 刷新完成`);
                    return true;
                }
                return false;
            },
            
            // 销毁iframe
            destroyIframe: function(containerId) {
                const containerData = this.containers.get(containerId);
                if (containerData) {
                    containerData.container.innerHTML = '';
                    containerData.container.style.display = 'none';
                    this.containers.delete(containerId);
                    console.log(`🗑️ ${containerData.type} iframe已销毁`);
                    return true;
                }
                return false;
            },
            
            // 切换视频源（远景/近景）
            switchVideoSource: function(toFar = true) {
                const farContainer = document.getElementById('video-far-container');
                const nearContainer = document.getElementById('video-near-container');
                
                if (toFar) {
                    farContainer.style.display = 'block';
                    nearContainer.style.display = 'none';
                    console.log('📹 切换到远景视频');
                } else {
                    farContainer.style.display = 'none';
                    nearContainer.style.display = 'block';
                    console.log('📹 切换到近景视频');
                }
            }
        };
        
        // Unity调用接口
        window.loadIframe = function(containerIdAndUrl) {
            const parts = containerIdAndUrl.split(',');
            const containerId = parts[0];
            const url = parts.slice(1).join(',');
            return window.BaccaratIframeManager.createIframe(containerId, url);
        };
        
        window.setIframeVisibility = function(containerIdAndVisibility) {
            const parts = containerIdAndVisibility.split(',');
            const containerId = parts[0];
            const visible = parts[1] === '1';
            return window.BaccaratIframeManager.setVisibility(containerId, visible);
        };
        
        window.refreshIframe = function(containerId) {
            return window.BaccaratIframeManager.refresh(containerId);
        };
        
        window.destroyIframe = function(containerId) {
            return window.BaccaratIframeManager.destroyIframe(containerId);
        };
        
        // 切换视频源的全局函数
        window.switchVideoSource = function(toFar) {
            return window.BaccaratIframeManager.switchVideoSource(toFar);
        };
        
        console.log('🎰 百家乐iframe管理器已加载');
    </script>
    
    <!-- 加载管理器 -->
    <script>
        // 详细加载管理器
        window.LoadingManager = {
            startTime: Date.now(),
            steps: [
                { id: 'step-env', name: '环境检测', duration: 500 },
                { id: 'step-webgl', name: 'WebGL初始化', duration: 800 },
                { id: 'step-loader', name: 'Unity Loader', duration: 2000 },
                { id: 'step-framework', name: 'Framework加载', duration: 3000 },
                { id: 'step-assets', name: '资源下载', duration: 0 }, // 动态计算
                { id: 'step-complete', name: '启动完成', duration: 500 }
            ],
            currentStepIndex: 0,
            totalProgress: 0,
            
            // 文件大小估算 (KB)
            fileSizes: {
                loader: 57,
                framework: 892,
                wasm: 158119,
                data: 21416
            },
            
            init: function() {
                // 计算总文件大小
                const totalSize = Object.values(this.fileSizes).reduce((a, b) => a + b, 0);
                document.getElementById('estimated-size').textContent = this.formatBytes(totalSize * 1024);
                
                // 开始第一步
                this.nextStep();
            },
            
            nextStep: function() {
                if (this.currentStepIndex < this.steps.length) {
                    const step = this.steps[this.currentStepIndex];
                    this.activateStep(step.id);
                    this.currentStepIndex++;
                }
            },
            
            activateStep: function(stepId) {
                // 标记前面的步骤为完成
                for (let i = 0; i < this.currentStepIndex; i++) {
                    const prevStep = document.getElementById(this.steps[i].id);
                    if (prevStep) {
                        prevStep.className = 'loading-step completed';
                        prevStep.querySelector('.step-icon').textContent = '✅';
                    }
                }
                
                // 激活当前步骤
                const currentStep = document.getElementById(stepId);
                if (currentStep) {
                    currentStep.className = 'loading-step active';
                    currentStep.querySelector('.step-icon').textContent = '⏳';
                }
                
                // 更新状态文本
                const stepName = this.steps.find(s => s.id === stepId)?.name || '处理中';
                document.getElementById('progress-status').textContent = stepName + '...';
            },
            
            updateProgress: function(progress, status = '') {
                this.totalProgress = Math.max(this.totalProgress, progress);
                
                document.getElementById('progress-fill').style.width = this.totalProgress + '%';
                document.getElementById('progress-percent').textContent = Math.round(this.totalProgress) + '%';
                
                if (status) {
                    document.getElementById('progress-status').textContent = status;
                }
                
                // 显示时间估算
                this.updateTimeEstimate();
            },
            
            updateTimeEstimate: function() {
                const elapsed = Date.now() - this.startTime;
                const estimateDiv = document.getElementById('time-estimate');
                
                if (this.totalProgress > 10) {
                    const totalEstimated = (elapsed / this.totalProgress) * 100;
                    const remaining = Math.max(0, totalEstimated - elapsed);
                    
                    document.getElementById('time-remaining').textContent = this.formatTime(remaining);
                    estimateDiv.style.display = 'block';
                }
            },
            
            complete: function() {
                // 标记所有步骤完成
                this.steps.forEach(step => {
                    const stepEl = document.getElementById(step.id);
                    if (stepEl) {
                        stepEl.className = 'loading-step completed';
                        stepEl.querySelector('.step-icon').textContent = '✅';
                    }
                });
                
                this.updateProgress(100, '游戏准备完成');
                
                // 延迟隐藏加载界面
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    document.getElementById('game-container').style.display = 'block';
                }, 1000);
            },
            
            error: function(message) {
                const currentStep = document.getElementById(this.steps[Math.max(0, this.currentStepIndex - 1)].id);
                if (currentStep) {
                    currentStep.className = 'loading-step error';
                    currentStep.querySelector('.step-icon').textContent = '❌';
                }
                
                document.getElementById('progress-status').textContent = '加载失败';
                document.getElementById('error-message').textContent = message;
                
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    document.getElementById('error-overlay').style.display = 'flex';
                }, 1000);
            },
            
            formatBytes: function(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            },
            
            formatTime: function(ms) {
                const seconds = Math.ceil(ms / 1000);
                if (seconds < 60) return seconds + ' 秒';
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return minutes + ' 分 ' + remainingSeconds + ' 秒';
            }
        };
    </script>
    
    <!-- 主初始化脚本 -->
    <script>
        // 全局变量
        let unityInstance = null;
        let compatibilityMode = false;
        
        // DOM元素
        const canvas = document.querySelector("#unity-canvas");
        
        // Canvas初始化
        function initializeCanvas() {
            DeviceCompatibilityManager.detectEnvironment();
            
            const targetWidth = parseInt('{{{ WIDTH }}}') || 750;
            const targetHeight = parseInt('{{{ HEIGHT }}}') || 1344;
            
            const optimalSize = DeviceCompatibilityManager.getOptimalCanvasSize(targetWidth, targetHeight);
            
            canvas.width = optimalSize.width;
            canvas.height = optimalSize.height;
            
            // Unity区域自适应，Canvas会自动缩放
            canvas.style.maxWidth = '100%';
            canvas.style.maxHeight = '100%';
            canvas.style.objectFit = 'contain';
            
            console.log(`✅ Canvas初始化: ${optimalSize.width}x${optimalSize.height}`);
            return optimalSize;
        }
        
        // 等待Unity Loader
        function waitForUnityLoader() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 200;
                
                const checkLoader = () => {
                    attempts++;
                    
                    if (window.UnityLoader || typeof createUnityInstance !== 'undefined') {
                        console.log('✅ Unity Loader准备就绪');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('Unity Loader加载超时'));
                    } else {
                        setTimeout(checkLoader, 100);
                    }
                };
                
                checkLoader();
            });
        }
        
        // 等待createUnityInstance
        function waitForCreateUnityInstance() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 200;
                
                const checkFunction = () => {
                    attempts++;
                    
                    if (typeof createUnityInstance !== 'undefined') {
                        console.log('✅ createUnityInstance函数就绪');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('createUnityInstance函数加载超时'));
                    } else {
                        setTimeout(checkFunction, 100);
                    }
                };
                
                checkFunction();
            });
        }
        
        // Unity资源加载进度回调
        function updateUnityProgress(progress) {
            const baseProgress = 60; // 前面步骤占60%
            const unityProgress = baseProgress + (progress * 35); // Unity资源加载占35%
            
            LoadingManager.updateProgress(unityProgress, `下载游戏资源 ${Math.round(progress * 100)}%`);
        }
        
        // 错误处理
        function onUnityError(error) {
            console.error("Unity错误:", error);
            LoadingManager.error(error.toString());
        }
        
        // Unity初始化主流程
        async function initializeUnity() {
            try {
                console.log('🚀 开始Unity初始化...');
                
                // 步骤1: 环境检测 (0-10%)
                LoadingManager.updateProgress(5, '检测设备环境...');
                const canvasSize = initializeCanvas();
                await new Promise(resolve => setTimeout(resolve, 500));
                LoadingManager.nextStep();
                LoadingManager.updateProgress(10, '环境检测完成');
                
                // 步骤2: WebGL初始化 (10-20%)
                LoadingManager.updateProgress(15, '初始化WebGL引擎...');
                await new Promise(resolve => setTimeout(resolve, 800));
                LoadingManager.nextStep();
                LoadingManager.updateProgress(20, 'WebGL引擎就绪');
                
                // 步骤3: Unity Loader (20-35%)
                LoadingManager.updateProgress(25, '加载Unity核心模块...');
                await waitForUnityLoader();
                LoadingManager.nextStep();
                LoadingManager.updateProgress(35, 'Unity核心模块就绪');
                
                // 步骤4: Framework (35-60%)
                LoadingManager.updateProgress(40, '初始化游戏框架...');
                await waitForCreateUnityInstance();
                LoadingManager.nextStep();
                LoadingManager.updateProgress(60, '游戏框架初始化完成');
                
                // 步骤5: 创建Unity实例和资源加载 (60-95%)
                LoadingManager.updateProgress(65, '创建游戏实例...');
                window.gameConfig = DeviceCompatibilityManager.getOptimizedUnityConfig();
                
                unityInstance = await createUnityInstance(canvas, window.gameConfig, updateUnityProgress);
                window.unityInstance = unityInstance;
                LoadingManager.nextStep();
                
                // 步骤6: 完成 (95-100%)
                LoadingManager.updateProgress(98, '启动游戏...');
                
                // 初始化游戏桥接
                if (window.unityBridge) {
                    window.unityBridge.initialize(unityInstance);
                }
                
                // 发送就绪事件
                window.dispatchEvent(new Event('unity-ready'));
                
                LoadingManager.nextStep();
                LoadingManager.complete();
                
                console.log("✅ Unity百家乐游戏初始化完成!");
                
                // 发送URL参数
                setTimeout(() => {
                    sendUrlParametersToUnity();
                }, 1000);
                
            } catch (error) {
                console.error("❌ Unity初始化失败:", error);
                onUnityError(error);
            }
        }
        
        // 发送URL参数到Unity
        function sendUrlParametersToUnity() {
            if (unityInstance) {
                try {
                    const params = new URLSearchParams(window.location.search);
                    const gameParams = {};
                    
                    ['table_id', 'game_type', 'user_id', 'token', 'language', 'currency', 'room_id'].forEach(name => {
                        if (params.has(name)) {
                            gameParams[name] = params.get(name);
                        }
                    });
                    
                    if (Object.keys(gameParams).length > 0) {
                        console.log('📤 发送URL参数到Unity:', gameParams);
                        unityInstance.SendMessage('GameManager', 'SetUrlParameters', JSON.stringify(gameParams));
                    }
                } catch (error) {
                    console.warn('⚠️ 发送URL参数失败:', error);
                }
            }
        }
        
        // 工具函数
        function toggleCompatibilityMode() {
            compatibilityMode = !compatibilityMode;
            localStorage.setItem('baccarat-compatibility-mode', compatibilityMode.toString());
            window.location.reload();
        }
        
        function contactSupport() {
            // 这里可以添加客服联系逻辑
            alert('请联系客服获取技术支持\n\n客服QQ: 123456789\n客服微信: support123');
        }
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎰 百家乐游戏页面加载完成');
            
            // 检查兼容性模式
            const savedCompatMode = localStorage.getItem('baccarat-compatibility-mode');
            if (savedCompatMode === 'true') {
                compatibilityMode = true;
            }
            
            // 初始化辅助脚本
            if (window.safariCompatibility) {
                window.safariCompatibility.initialize();
            }
            
            if (window.errorHandler) {
                window.errorHandler.initialize();
            }
            
            // 初始化加载管理器
            LoadingManager.init();
            
            // 开始Unity初始化
            setTimeout(() => {
                initializeUnity();
            }, 1000);
        });
        
        // 页面卸载清理
        window.addEventListener('beforeunload', () => {
            if (unityInstance) {
                try {
                    unityInstance.Quit();
                } catch (e) {
                    console.warn('Unity退出警告:', e);
                }
            }
        });
        
        console.log('🎰 百家乐游戏 - 专业版本已加载');
    </script>

</body>
</html>