<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>Unity WebGL æ­£ç¡®åŠ è½½</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f0f0; }
        .container { max-width: 800px; margin: 0 auto; }
        .panel { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .progress-bar { width: 100%; height: 20px; background: #ddd; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #2196F3); width: 0%; transition: width 0.3s; }
        .status { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .warning { background: #fff3e0; color: #f57c00; }
        .error { background: #ffebee; color: #c62828; }
        .info { background: #e3f2fd; color: #1976d2; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; background: #2196F3; color: white; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #unity-canvas { border: 1px solid #ccc; border-radius: 8px; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® Unity WebGL æ­£ç¡®åŠ è½½</h1>
        
        <div class="panel">
            <h3>ğŸ“Š åŠ è½½çŠ¶æ€</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progress"></div>
            </div>
            <div id="status">å‡†å¤‡å¼€å§‹...</div>
            <div id="details"></div>
            <button onclick="startCorrectLoad()" id="start-btn">å¼€å§‹æ­£ç¡®åŠ è½½</button>
        </div>
        
        <div class="panel">
            <canvas id="unity-canvas" width="800" height="600"></canvas>
        </div>
        
        <div class="panel">
            <h3>ğŸ“ åŠ è½½æ—¥å¿—</h3>
            <div id="log-container" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
        </div>
    </div>

    <script>
        let unityInstance = null;
        const progressBar = document.getElementById('progress');
        const statusDiv = document.getElementById('status');
        const detailsDiv = document.getElementById('details');
        const logContainer = document.getElementById('log-container');
        const canvas = document.getElementById('unity-canvas');
        const startBtn = document.getElementById('start-btn');

        function addLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = `${time} - ${message}`;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateProgress(percent, status, details = '') {
            progressBar.style.width = percent + '%';
            statusDiv.textContent = status;
            detailsDiv.textContent = details;
        }

        async function startCorrectLoad() {
            startBtn.disabled = true;
            addLog('ğŸš€ å¼€å§‹æ­£ç¡®çš„Unity WebGLåŠ è½½æµç¨‹', 'info');
            
            try {
                // æ­¥éª¤1: æ¸…ç†ä¹‹å‰çš„è„šæœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
                updateProgress(5, 'æ¸…ç†ç¯å¢ƒ...', 'ç§»é™¤ä¹‹å‰åŠ è½½çš„è„šæœ¬');
                cleanupScripts();
                
                // æ­¥éª¤2: åŠ è½½ Loader.js
                updateProgress(10, 'åŠ è½½ Loader...', 'æ­£åœ¨åŠ è½½ Unity Loader');
                await loadUnityLoader();
                addLog('âœ… Unity Loader åŠ è½½å®Œæˆ', 'success');
                
                // æ­¥éª¤3: ç­‰å¾… Loader åˆå§‹åŒ–
                updateProgress(20, 'åˆå§‹åŒ– Loader...', 'ç­‰å¾… Loader å‡†å¤‡å®Œæˆ');
                await waitForLoader();
                addLog('âœ… Unity Loader åˆå§‹åŒ–å®Œæˆ', 'success');
                
                // æ­¥éª¤4: é€šè¿‡ Loader åŠ è½½ Framework
                updateProgress(30, 'åŠ è½½ Framework...', 'é€šè¿‡ Loader åŠ è½½ Framework');
                await loadUnityFramework();
                addLog('âœ… Unity Framework åŠ è½½å®Œæˆ', 'success');
                
                // æ­¥éª¤5: éªŒè¯ createUnityInstance
                updateProgress(40, 'éªŒè¯ Unity å‡½æ•°...', 'æ£€æŸ¥ createUnityInstance å¯ç”¨æ€§');
                if (typeof createUnityInstance === 'undefined') {
                    throw new Error('createUnityInstance ä»ç„¶ä¸å¯ç”¨');
                }
                addLog('âœ… createUnityInstance å‡½æ•°å·²å°±ç»ª', 'success');
                
                // æ­¥éª¤6: åˆ›å»º Unity å®ä¾‹
                updateProgress(50, 'åˆ›å»º Unity å®ä¾‹...', 'æ­£åœ¨åˆå§‹åŒ–æ¸¸æˆ');
                await createUnityGame();
                
                updateProgress(100, 'åŠ è½½å®Œæˆï¼', 'æ¸¸æˆå·²å‡†å¤‡å°±ç»ª');
                addLog('ğŸ‰ Unity æ¸¸æˆåŠ è½½æˆåŠŸï¼', 'success');
                
                // æ˜¾ç¤ºæ¸¸æˆ
                showGame();
                
            } catch (error) {
                addLog(`âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                updateProgress(0, 'åŠ è½½å¤±è´¥', error.message);
                startBtn.disabled = false;
            }
        }

        function cleanupScripts() {
            // ç§»é™¤ä¹‹å‰å¯èƒ½åŠ è½½çš„ Unity è„šæœ¬
            const existingScripts = document.querySelectorAll('script[src*="dj_game_test"]');
            existingScripts.forEach(script => {
                addLog(`ç§»é™¤è„šæœ¬: ${script.src}`, 'info');
                script.remove();
            });
            
            // æ¸…ç†å…¨å±€å˜é‡
            if (window.unityInstance) {
                delete window.unityInstance;
            }
            if (window.createUnityInstance) {
                delete window.createUnityInstance;
            }
        }

        function loadUnityLoader() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'Build/dj_game_test.loader.js';
                
                script.onload = () => {
                    addLog('Loader è„šæœ¬æ–‡ä»¶åŠ è½½å®Œæˆ', 'info');
                    resolve();
                };
                
                script.onerror = (error) => {
                    reject(new Error(`Loader è„šæœ¬åŠ è½½å¤±è´¥: ${error}`));
                };
                
                // è®¾ç½®è¶…æ—¶
                setTimeout(() => {
                    reject(new Error('Loader è„šæœ¬åŠ è½½è¶…æ—¶'));
                }, 10000);
                
                document.head.appendChild(script);
                addLog('å¼€å§‹åŠ è½½ Loader è„šæœ¬...', 'info');
            });
        }

        function waitForLoader() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 5ç§’
                
                const checkLoader = () => {
                    // æ£€æŸ¥ Unity Loader æ˜¯å¦å·²ç»å‡†å¤‡å¥½
                    if (window.UnityLoader || window.createUnityInstance) {
                        addLog('æ£€æµ‹åˆ° Unity Loader å…¨å±€å¯¹è±¡', 'info');
                        resolve();
                    } else if (attempts++ < maxAttempts) {
                        setTimeout(checkLoader, 100);
                    } else {
                        reject(new Error('Unity Loader åˆå§‹åŒ–è¶…æ—¶'));
                    }
                };
                
                checkLoader();
            });
        }

        function loadUnityFramework() {
            return new Promise((resolve, reject) => {
                // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ createUnityInstance
                if (typeof createUnityInstance !== 'undefined') {
                    addLog('createUnityInstance å·²ç»å¯ç”¨ï¼Œè·³è¿‡ Framework åŠ è½½', 'info');
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'Build/dj_game_test.framework.js';
                
                script.onload = () => {
                    addLog('Framework è„šæœ¬æ–‡ä»¶åŠ è½½å®Œæˆ', 'info');
                    
                    // ç­‰å¾…ä¸€ä¸‹è®©è„šæœ¬æ‰§è¡Œ
                    setTimeout(() => {
                        if (typeof createUnityInstance !== 'undefined') {
                            resolve();
                        } else {
                            reject(new Error('Framework åŠ è½½å createUnityInstance ä»ä¸å¯ç”¨'));
                        }
                    }, 200);
                };
                
                script.onerror = (error) => {
                    reject(new Error(`Framework è„šæœ¬åŠ è½½å¤±è´¥: ${error}`));
                };
                
                // è®¾ç½®è¶…æ—¶
                setTimeout(() => {
                    reject(new Error('Framework è„šæœ¬åŠ è½½è¶…æ—¶'));
                }, 15000);
                
                document.head.appendChild(script);
                addLog('å¼€å§‹åŠ è½½ Framework è„šæœ¬...', 'info');
            });
        }

        async function createUnityGame() {
            const config = {
                dataUrl: "Build/dj_game_test.data",
                frameworkUrl: "Build/dj_game_test.framework.js", 
                codeUrl: "Build/dj_game_test.wasm",
                streamingAssetsUrl: "StreamingAssets",
                companyName: "Game Studio",
                productName: "DJ Game Test",
                productVersion: "1.0.0",
            };

            addLog('Unity é…ç½®: ' + JSON.stringify(config, null, 2), 'info');

            return new Promise((resolve, reject) => {
                createUnityInstance(canvas, config, (progress) => {
                    const percent = Math.round(progress * 100);
                    const adjustedProgress = 50 + (percent * 0.5); // 50% åˆ° 100%
                    updateProgress(adjustedProgress, `åŠ è½½æ¸¸æˆèµ„æº... ${percent}%`, 'æ­£åœ¨ä¸‹è½½å’Œåˆå§‹åŒ–æ¸¸æˆæ•°æ®');
                    
                    if (percent % 10 === 0) {
                        addLog(`æ¸¸æˆèµ„æºåŠ è½½è¿›åº¦: ${percent}%`, 'info');
                    }
                }).then((unity) => {
                    unityInstance = unity;
                    window.unityInstance = unity;
                    addLog('Unity å®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                    resolve(unity);
                }).catch((error) => {
                    addLog(`Unity å®ä¾‹åˆ›å»ºå¤±è´¥: ${error}`, 'error');
                    reject(error);
                });
            });
        }

        function showGame() {
            canvas.style.display = 'block';
            canvas.style.width = '100%';
            canvas.style.maxWidth = '800px';
            canvas.style.height = 'auto';
            addLog('æ¸¸æˆç”»å¸ƒå·²æ˜¾ç¤º', 'info');
        }

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(event) {
            addLog(`å…¨å±€é”™è¯¯: ${event.error?.message || event.message}`, 'error');
        });

        window.addEventListener('unhandledrejection', function(event) {
            addLog(`Promise é”™è¯¯: ${event.reason}`, 'error');
        });

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            addLog('é¡µé¢åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹UnityåŠ è½½æµç¨‹', 'info');
        });
    </script>
</body>
</html>