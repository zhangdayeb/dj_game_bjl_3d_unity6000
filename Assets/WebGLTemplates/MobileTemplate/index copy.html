<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <title>百家乐游戏</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="专业的在线百家乐游戏平台，支持实时视频直播和多种投注玩法">
    <meta name="keywords" content="百家乐,在线游戏,真人娱乐,WebGL游戏">
    <meta name="author" content="Baccarat Game Team">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="百家乐游戏">
    <meta property="og:description" content="专业的在线百家乐游戏平台">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{{ UNITY_CUSTOM_WEBSITE_URL }}}">
    <meta property="og:image" content="TemplateData/og-image.jpg">
    
    <!-- Favicon -->
    <link rel="icon" href="Assets/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="Assets/favicon.ico" type="image/x-icon">
    
    <!-- Preload Critical Resources -->
    <link rel="preload" href="TemplateData/style.css" as="style">
    <!-- 🔥 修正：移除对不存在文件的预加载 -->
    <link rel="preload" href="Build/{{{ FRAMEWORK_FILENAME }}}" as="script">
    <link rel="preload" href="Build/{{{ CODE_FILENAME }}}" as="fetch" crossorigin>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="TemplateData/style.css">
    
    <!-- WebGL Detection -->
    <script>
        // WebGL支持检测
        function checkWebGLSupport() {
            try {
                var canvas = document.createElement('canvas');
                var gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                return !!gl;
            } catch(e) {
                return false;
            }
        }
        
        // 如果不支持WebGL，显示错误页面
        if (!checkWebGLSupport()) {
            document.addEventListener('DOMContentLoaded', function() {
                document.body.innerHTML = `
                    <div class="webgl-not-supported">
                        <h2>您的浏览器不支持WebGL</h2>
                        <p>请使用支持WebGL的现代浏览器访问本游戏</p>
                        <p>推荐浏览器：Chrome、Firefox、Safari、Edge</p>
                    </div>
                `;
            });
        }
    </script>
</head>

<body>
    <!-- 加载屏幕 -->
    <div id="unity-container" class="unity-desktop">
        <!-- 游戏画布 -->
        <canvas id="unity-canvas" width={{{ WIDTH }}} height={{{ HEIGHT }}} tabindex="-1"></canvas>
        
        <!-- 加载界面 -->
        <div id="unity-loading-bar">
            <div id="unity-logo">
                <img src="Assets/logo.png" alt="游戏Logo" onerror="this.style.display='none'">
            </div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
            <div id="unity-progress-text">加载中...</div>
        </div>
        
        <!-- 全屏按钮 -->
        <div id="unity-fullscreen-button" title="全屏模式" style="display: none;"></div>
    </div>
    
    <!-- 错误提示界面 -->
    <div id="error-container" style="display: none;">
        <div class="error-content">
            <h2>游戏加载失败</h2>
            <p id="error-message">请检查网络连接后重试</p>
            <button id="retry-button" onclick="window.location.reload()">重新加载</button>
        </div>
    </div>
    
    <!-- 不支持移动端提示 -->
    <div id="mobile-warning" class="mobile-only">
        <div class="mobile-content">
            <h2>移动端优化中</h2>
            <p>为了获得最佳游戏体验，建议您使用电脑访问</p>
            <button onclick="hideMobileWarning()">继续游戏</button>
        </div>
    </div>
    
    <!-- 🔥 修正：直接加载 framework.js，它包含了 createUnityInstance -->
    <script src="Build/{{{ FRAMEWORK_FILENAME }}}"></script>
    
    <!-- 游戏桥接脚本 -->
    <script src="TemplateData/unity-bridge.js"></script>
    
    <!-- Safari兼容性脚本 -->
    <script src="TemplateData/safari-compatibility.js"></script>
    
    <!-- 错误处理脚本 -->
    <script src="TemplateData/error-handler.js"></script>
    
    <!-- 🔥 iframe 管理脚本 -->
    <script>
        // ================================================================================================
        // iframe 管理功能 - 移动端优化版
        // ================================================================================================
        
        /**
         * 通用 iframe 加载函数
         * Unity 调用: CallWebGLFunction("loadIframe", "容器ID,URL")
         */
        window.loadIframe = function(containerIdAndUrl) {
            try {
                console.log('🎯 loadIframe 调用:', containerIdAndUrl);
                
                var parts = containerIdAndUrl.split(',');
                var containerId = parts[0];
                var url = parts.slice(1).join(','); // 处理URL中可能包含逗号的情况
                
                console.log('📦 容器ID:', containerId);
                console.log('🔗 URL:', url);
                
                // 查找或创建容器
                var container = document.getElementById(containerId);
                if (!container) {
                    container = document.createElement('div');
                    container.id = containerId;
                    // 移动端优化的容器样式
                    container.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        z-index: 1000;
                        background: rgba(0, 0, 0, 0.95);
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                    `;
                    document.body.appendChild(container);
                    console.log('✅ 容器已创建:', containerId);
                }
                
                // 创建 iframe 包装器
                var wrapper = document.createElement('div');
                wrapper.style.cssText = `
                    width: 100%;
                    height: 100%;
                    max-width: 750px;
                    max-height: 1344px;
                    position: relative;
                    background: #000;
                    border-radius: 8px;
                    overflow: hidden;
                `;
                
                // 创建关闭按钮
                var closeBtn = document.createElement('button');
                closeBtn.innerHTML = '✕';
                closeBtn.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    width: 40px;
                    height: 40px;
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    border: 2px solid rgba(255, 255, 255, 0.3);
                    border-radius: 50%;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    z-index: 1001;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s ease;
                `;
                
                // 关闭按钮事件
                closeBtn.onclick = function() {
                    console.log('🚫 关闭iframe:', containerId);
                    if (container && container.parentNode) {
                        container.parentNode.removeChild(container);
                    }
                };
                
                // 关闭按钮悬停效果
                closeBtn.onmouseover = function() {
                    this.style.background = 'rgba(255, 0, 0, 0.8)';
                    this.style.borderColor = 'rgba(255, 255, 255, 0.6)';
                };
                closeBtn.onmouseout = function() {
                    this.style.background = 'rgba(0, 0, 0, 0.8)';
                    this.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                };
                
                // 创建 iframe
                var iframe = document.createElement('iframe');
                iframe.src = url;
                iframe.style.cssText = `
                    width: 100%;
                    height: 100%;
                    border: none;
                    display: block;
                    background: #000;
                `;
                iframe.setAttribute('allowfullscreen', 'true');
                iframe.setAttribute('frameborder', '0');
                iframe.setAttribute('scrolling', 'no');
                iframe.setAttribute('allow', 'autoplay; fullscreen');
                
                // iframe 加载事件
                iframe.onload = function() {
                    console.log('✅ iframe 加载完成:', url);
                };
                
                iframe.onerror = function() {
                    console.error('❌ iframe 加载失败:', url);
                };
                
                // 组装元素
                container.innerHTML = '';
                wrapper.appendChild(iframe);
                wrapper.appendChild(closeBtn);
                container.appendChild(wrapper);
                
                console.log('✅ iframe 加载成功:', containerId, url);
                return true;
                
            } catch (e) {
                console.error('❌ loadIframe 失败:', e);
                return false;
            }
        };
        
        /**
         * 设置 iframe 可见性
         * Unity 调用: CallWebGLFunction("setIframeVisibility", "容器ID,1") // 1=显示, 0=隐藏
         */
        window.setIframeVisibility = function(containerIdAndVisibility) {
            try {
                var parts = containerIdAndVisibility.split(',');
                var containerId = parts[0];
                var visible = parts[1] === '1';
                
                var container = document.getElementById(containerId);
                if (container) {
                    container.style.display = visible ? 'flex' : 'none';
                    console.log('🔄 iframe 可见性设置:', containerId, visible ? '显示' : '隐藏');
                    return true;
                } else {
                    console.warn('⚠️ 未找到容器:', containerId);
                    return false;
                }
            } catch (e) {
                console.error('❌ setIframeVisibility 失败:', e);
                return false;
            }
        };
        
        /**
         * 刷新 iframe
         * Unity 调用: CallWebGLFunction("refreshIframe", "容器ID")
         */
        window.refreshIframe = function(containerId) {
            try {
                var container = document.getElementById(containerId);
                if (container) {
                    var iframe = container.querySelector('iframe');
                    if (iframe) {
                        var currentSrc = iframe.src;
                        iframe.src = '';
                        setTimeout(function() {
                            iframe.src = currentSrc;
                        }, 100);
                        console.log('🔄 iframe 已刷新:', containerId);
                        return true;
                    }
                }
                console.warn('⚠️ 未找到要刷新的iframe:', containerId);
                return false;
            } catch (e) {
                console.error('❌ refreshIframe 失败:', e);
                return false;
            }
        };
        
        /**
         * 销毁 iframe
         * Unity 调用: CallWebGLFunction("destroyIframe", "容器ID")
         */
        window.destroyIframe = function(containerId) {
            try {
                var container = document.getElementById(containerId);
                if (container && container.parentNode) {
                    container.parentNode.removeChild(container);
                    console.log('🗑️ iframe 已销毁:', containerId);
                    return true;
                }
                return false;
            } catch (e) {
                console.error('❌ destroyIframe 失败:', e);
                return false;
            }
        };
        
        // 键盘 ESC 关闭功能
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                // 查找所有活跃的iframe容器并关闭最新的一个
                var containers = document.querySelectorAll('[id$="-container"]');
                if (containers.length > 0) {
                    var latestContainer = containers[containers.length - 1];
                    if (latestContainer.style.display !== 'none') {
                        latestContainer.style.display = 'none';
                        console.log('⌨️ ESC 关闭iframe:', latestContainer.id);
                    }
                }
            }
        });
        
        console.log('🚀 iframe 管理功能已加载');
        console.log('📋 可用函数:', ['loadIframe', 'setIframeVisibility', 'refreshIframe', 'destroyIframe']);
    </script>
    
    <!-- 主初始化脚本 -->
    <script>
        // 🔥 修正的全局配置 - 移除对 LOADER_FILENAME 的引用
        window.gameConfig = {
            buildUrl: "Build",
            dataUrl: "Build/{{{ DATA_FILENAME }}}",
            frameworkUrl: "Build/{{{ FRAMEWORK_FILENAME }}}",
            codeUrl: "Build/{{{ CODE_FILENAME }}}",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "{{{ COMPANY_NAME }}}",
            productName: "{{{ PRODUCT_NAME }}}",
            productVersion: "{{{ PRODUCT_VERSION }}}",
        };

        // Unity实例
        var unityInstance = null;
        var container = document.querySelector("#unity-container");
        var canvas = document.querySelector("#unity-canvas");
        var loadingBar = document.querySelector("#unity-loading-bar");
        var progressBarFull = document.querySelector("#unity-progress-bar-full");
        var progressText = document.querySelector("#unity-progress-text");
        var fullscreenButton = document.querySelector("#unity-fullscreen-button");

        // 加载进度回调
        function updateProgress(progress) {
            progressBarFull.style.width = 100 * progress + "%";
            progressText.textContent = Math.round(progress * 100) + "%";
            
            if (progress >= 1) {
                setTimeout(function() {
                    loadingBar.style.display = "none";
                    fullscreenButton.style.display = "block";
                }, 500);
            }
        }

        // 错误处理回调
        function onUnityError(error) {
            console.error("Unity错误:", error);
            
            loadingBar.style.display = "none";
            document.getElementById("error-container").style.display = "flex";
            document.getElementById("error-message").textContent = error || "游戏加载失败，请重试";
            
            // 发送错误报告
            if (window.errorHandler) {
                window.errorHandler.reportError('unity_load_error', error);
            }
        }

        // 🔥 修正的 Unity 初始化函数
        function initializeUnity() {
            // 检查 createUnityInstance 是否存在
            if (typeof createUnityInstance === 'undefined') {
                console.error('createUnityInstance 不存在，检查 framework.js 是否正确加载');
                onUnityError('Unity 框架加载失败');
                return;
            }
            
            createUnityInstance(canvas, window.gameConfig, updateProgress)
                .then((unity) => {
                    unityInstance = unity;
                    window.unityInstance = unity; // 🔥 保存全局引用
                    
                    // 设置全屏按钮
                    fullscreenButton.onclick = () => {
                        unityInstance.SetFullscreen(1);
                    };
                    
                    // 初始化游戏桥接
                    if (window.unityBridge) {
                        window.unityBridge.initialize(unityInstance);
                    }
                    
                    // 游戏加载完成事件
                    window.dispatchEvent(new Event('unity-ready'));
                    
                    console.log("✅ Unity游戏初始化完成");
                })
                .catch((error) => {
                    console.error("❌ Unity 初始化失败:", error);
                    onUnityError(error);
                });
        }

        // 移动端警告处理
        function hideMobileWarning() {
            document.getElementById("mobile-warning").style.display = "none";
        }

        // 检测移动端
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // 🔥 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 移动端检测
            if (isMobile()) {
                container.className = "unity-mobile";
                // 如果需要显示移动端警告，取消下面注释
                // document.getElementById("mobile-warning").style.display = "flex";
            }
            
            // Safari音频兼容性处理（如果脚本存在）
            if (window.safariCompatibility) {
                window.safariCompatibility.initialize();
            }
            
            // 错误处理初始化（如果脚本存在）
            if (window.errorHandler) {
                window.errorHandler.initialize();
            }
            
            // 🔥 延迟初始化Unity，确保 framework.js 已加载
            setTimeout(function() {
                console.log('🚀 开始初始化 Unity...');
                initializeUnity();
            }, 200); // 增加延迟时间
        });

        // 页面卸载时清理
        window.addEventListener('beforeunload', function() {
            if (unityInstance) {
                unityInstance.Quit();
            }
        });

        // 窗口大小改变时调整画布
        window.addEventListener('resize', function() {
            if (unityInstance && !document.fullscreenElement) {
                // 响应式调整逻辑
                var containerRect = container.getBoundingClientRect();
                var gameWidth = {{{ WIDTH }}};
                var gameHeight = {{{ HEIGHT }}};
                var aspectRatio = gameWidth / gameHeight;
                
                var newWidth = containerRect.width;
                var newHeight = newWidth / aspectRatio;
                
                if (newHeight > window.innerHeight * 0.9) {
                    newHeight = window.innerHeight * 0.9;
                    newWidth = newHeight * aspectRatio;
                }
                
                canvas.style.width = newWidth + 'px';
                canvas.style.height = newHeight + 'px';
            }
        });

        // 全局错误捕获
        window.addEventListener('error', function(event) {
            console.error('页面错误:', event.error);
            if (window.errorHandler) {
                window.errorHandler.reportError('page_error', event.error?.message || '未知错误');
            }
        });

        // URL参数解析 - 传递给Unity
        function getUrlParams() {
            var params = new URLSearchParams(window.location.search);
            var gameParams = {};
            
            // 提取游戏参数
            var paramNames = ['table_id', 'game_type', 'user_id', 'token', 'language', 'currency'];
            paramNames.forEach(function(name) {
                if (params.has(name)) {
                    gameParams[name] = params.get(name);
                }
            });
            
            return gameParams;
        }

        // 向Unity发送URL参数
        window.addEventListener('unity-ready', function() {
            if (unityInstance) {
                var urlParams = getUrlParams();
                if (Object.keys(urlParams).length > 0) {
                    unityInstance.SendMessage('GameManager', 'SetUrlParameters', JSON.stringify(urlParams));
                }
            }
        });
    </script>

    <!-- Google Analytics 或其他分析脚本 -->
    <!-- 
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'GA_MEASUREMENT_ID');
    </script>
    -->
    
</body>
</html>