<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <title>ç™¾å®¶ä¹æ¸¸æˆ</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="ä¸“ä¸šçš„åœ¨çº¿ç™¾å®¶ä¹æ¸¸æˆå¹³å°ï¼Œæ”¯æŒå®æ—¶è§†é¢‘ç›´æ’­å’Œå¤šç§æŠ•æ³¨ç©æ³•">
    <meta name="keywords" content="ç™¾å®¶ä¹,åœ¨çº¿æ¸¸æˆ,çœŸäººå¨±ä¹,WebGLæ¸¸æˆ">
    <meta name="author" content="Baccarat Game Team">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="ç™¾å®¶ä¹æ¸¸æˆ">
    <meta property="og:description" content="ä¸“ä¸šçš„åœ¨çº¿ç™¾å®¶ä¹æ¸¸æˆå¹³å°">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{{ UNITY_CUSTOM_WEBSITE_URL }}}">
    <meta property="og:image" content="TemplateData/og-image.jpg">
    
    <!-- Favicon -->
    <link rel="icon" href="Assets/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="Assets/favicon.ico" type="image/x-icon">
    
    <!-- Preload Critical Resources -->
    <link rel="preload" href="TemplateData/style.css" as="style">
    <!-- ğŸ”¥ ä¿®æ­£ï¼šç§»é™¤å¯¹ä¸å­˜åœ¨æ–‡ä»¶çš„é¢„åŠ è½½ -->
    <link rel="preload" href="Build/{{{ FRAMEWORK_FILENAME }}}" as="script">
    <link rel="preload" href="Build/{{{ CODE_FILENAME }}}" as="fetch" crossorigin>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="TemplateData/style.css">
    
    <!-- WebGL Detection -->
    <script>
        // WebGLæ”¯æŒæ£€æµ‹
        function checkWebGLSupport() {
            try {
                var canvas = document.createElement('canvas');
                var gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                return !!gl;
            } catch(e) {
                return false;
            }
        }
        
        // å¦‚æœä¸æ”¯æŒWebGLï¼Œæ˜¾ç¤ºé”™è¯¯é¡µé¢
        if (!checkWebGLSupport()) {
            document.addEventListener('DOMContentLoaded', function() {
                document.body.innerHTML = `
                    <div class="webgl-not-supported">
                        <h2>æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebGL</h2>
                        <p>è¯·ä½¿ç”¨æ”¯æŒWebGLçš„ç°ä»£æµè§ˆå™¨è®¿é—®æœ¬æ¸¸æˆ</p>
                        <p>æ¨èæµè§ˆå™¨ï¼šChromeã€Firefoxã€Safariã€Edge</p>
                    </div>
                `;
            });
        }
    </script>
</head>

<body>
    <!-- åŠ è½½å±å¹• -->
    <div id="unity-container" class="unity-desktop">
        <!-- æ¸¸æˆç”»å¸ƒ -->
        <canvas id="unity-canvas" width={{{ WIDTH }}} height={{{ HEIGHT }}} tabindex="-1"></canvas>
        
        <!-- åŠ è½½ç•Œé¢ -->
        <div id="unity-loading-bar">
            <div id="unity-logo">
                <img src="Assets/logo.png" alt="æ¸¸æˆLogo" onerror="this.style.display='none'">
            </div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
            <div id="unity-progress-text">åŠ è½½ä¸­...</div>
        </div>
        
        <!-- å…¨å±æŒ‰é’® -->
        <div id="unity-fullscreen-button" title="å…¨å±æ¨¡å¼" style="display: none;"></div>
    </div>
    
    <!-- é”™è¯¯æç¤ºç•Œé¢ -->
    <div id="error-container" style="display: none;">
        <div class="error-content">
            <h2>æ¸¸æˆåŠ è½½å¤±è´¥</h2>
            <p id="error-message">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</p>
            <button id="retry-button" onclick="window.location.reload()">é‡æ–°åŠ è½½</button>
        </div>
    </div>
    
    <!-- ä¸æ”¯æŒç§»åŠ¨ç«¯æç¤º -->
    <div id="mobile-warning" class="mobile-only">
        <div class="mobile-content">
            <h2>ç§»åŠ¨ç«¯ä¼˜åŒ–ä¸­</h2>
            <p>ä¸ºäº†è·å¾—æœ€ä½³æ¸¸æˆä½“éªŒï¼Œå»ºè®®æ‚¨ä½¿ç”¨ç”µè„‘è®¿é—®</p>
            <button onclick="hideMobileWarning()">ç»§ç»­æ¸¸æˆ</button>
        </div>
    </div>
    
    <!-- ğŸ”¥ ä¿®æ­£ï¼šç›´æ¥åŠ è½½ framework.jsï¼Œå®ƒåŒ…å«äº† createUnityInstance -->
    <script src="Build/{{{ FRAMEWORK_FILENAME }}}"></script>
    
    <!-- æ¸¸æˆæ¡¥æ¥è„šæœ¬ -->
    <script src="TemplateData/unity-bridge.js"></script>
    
    <!-- Safariå…¼å®¹æ€§è„šæœ¬ -->
    <script src="TemplateData/safari-compatibility.js"></script>
    
    <!-- é”™è¯¯å¤„ç†è„šæœ¬ -->
    <script src="TemplateData/error-handler.js"></script>
    
    <!-- ğŸ”¥ iframe ç®¡ç†è„šæœ¬ -->
    <script>
        // ================================================================================================
        // iframe ç®¡ç†åŠŸèƒ½ - ç§»åŠ¨ç«¯ä¼˜åŒ–ç‰ˆ
        // ================================================================================================
        
        /**
         * é€šç”¨ iframe åŠ è½½å‡½æ•°
         * Unity è°ƒç”¨: CallWebGLFunction("loadIframe", "å®¹å™¨ID,URL")
         */
        window.loadIframe = function(containerIdAndUrl) {
            try {
                console.log('ğŸ¯ loadIframe è°ƒç”¨:', containerIdAndUrl);
                
                var parts = containerIdAndUrl.split(',');
                var containerId = parts[0];
                var url = parts.slice(1).join(','); // å¤„ç†URLä¸­å¯èƒ½åŒ…å«é€—å·çš„æƒ…å†µ
                
                console.log('ğŸ“¦ å®¹å™¨ID:', containerId);
                console.log('ğŸ”— URL:', url);
                
                // æŸ¥æ‰¾æˆ–åˆ›å»ºå®¹å™¨
                var container = document.getElementById(containerId);
                if (!container) {
                    container = document.createElement('div');
                    container.id = containerId;
                    // ç§»åŠ¨ç«¯ä¼˜åŒ–çš„å®¹å™¨æ ·å¼
                    container.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        z-index: 1000;
                        background: rgba(0, 0, 0, 0.95);
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                    `;
                    document.body.appendChild(container);
                    console.log('âœ… å®¹å™¨å·²åˆ›å»º:', containerId);
                }
                
                // åˆ›å»º iframe åŒ…è£…å™¨
                var wrapper = document.createElement('div');
                wrapper.style.cssText = `
                    width: 100%;
                    height: 100%;
                    max-width: 750px;
                    max-height: 1344px;
                    position: relative;
                    background: #000;
                    border-radius: 8px;
                    overflow: hidden;
                `;
                
                // åˆ›å»ºå…³é—­æŒ‰é’®
                var closeBtn = document.createElement('button');
                closeBtn.innerHTML = 'âœ•';
                closeBtn.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    width: 40px;
                    height: 40px;
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    border: 2px solid rgba(255, 255, 255, 0.3);
                    border-radius: 50%;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    z-index: 1001;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s ease;
                `;
                
                // å…³é—­æŒ‰é’®äº‹ä»¶
                closeBtn.onclick = function() {
                    console.log('ğŸš« å…³é—­iframe:', containerId);
                    if (container && container.parentNode) {
                        container.parentNode.removeChild(container);
                    }
                };
                
                // å…³é—­æŒ‰é’®æ‚¬åœæ•ˆæœ
                closeBtn.onmouseover = function() {
                    this.style.background = 'rgba(255, 0, 0, 0.8)';
                    this.style.borderColor = 'rgba(255, 255, 255, 0.6)';
                };
                closeBtn.onmouseout = function() {
                    this.style.background = 'rgba(0, 0, 0, 0.8)';
                    this.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                };
                
                // åˆ›å»º iframe
                var iframe = document.createElement('iframe');
                iframe.src = url;
                iframe.style.cssText = `
                    width: 100%;
                    height: 100%;
                    border: none;
                    display: block;
                    background: #000;
                `;
                iframe.setAttribute('allowfullscreen', 'true');
                iframe.setAttribute('frameborder', '0');
                iframe.setAttribute('scrolling', 'no');
                iframe.setAttribute('allow', 'autoplay; fullscreen');
                
                // iframe åŠ è½½äº‹ä»¶
                iframe.onload = function() {
                    console.log('âœ… iframe åŠ è½½å®Œæˆ:', url);
                };
                
                iframe.onerror = function() {
                    console.error('âŒ iframe åŠ è½½å¤±è´¥:', url);
                };
                
                // ç»„è£…å…ƒç´ 
                container.innerHTML = '';
                wrapper.appendChild(iframe);
                wrapper.appendChild(closeBtn);
                container.appendChild(wrapper);
                
                console.log('âœ… iframe åŠ è½½æˆåŠŸ:', containerId, url);
                return true;
                
            } catch (e) {
                console.error('âŒ loadIframe å¤±è´¥:', e);
                return false;
            }
        };
        
        /**
         * è®¾ç½® iframe å¯è§æ€§
         * Unity è°ƒç”¨: CallWebGLFunction("setIframeVisibility", "å®¹å™¨ID,1") // 1=æ˜¾ç¤º, 0=éšè—
         */
        window.setIframeVisibility = function(containerIdAndVisibility) {
            try {
                var parts = containerIdAndVisibility.split(',');
                var containerId = parts[0];
                var visible = parts[1] === '1';
                
                var container = document.getElementById(containerId);
                if (container) {
                    container.style.display = visible ? 'flex' : 'none';
                    console.log('ğŸ”„ iframe å¯è§æ€§è®¾ç½®:', containerId, visible ? 'æ˜¾ç¤º' : 'éšè—');
                    return true;
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°å®¹å™¨:', containerId);
                    return false;
                }
            } catch (e) {
                console.error('âŒ setIframeVisibility å¤±è´¥:', e);
                return false;
            }
        };
        
        /**
         * åˆ·æ–° iframe
         * Unity è°ƒç”¨: CallWebGLFunction("refreshIframe", "å®¹å™¨ID")
         */
        window.refreshIframe = function(containerId) {
            try {
                var container = document.getElementById(containerId);
                if (container) {
                    var iframe = container.querySelector('iframe');
                    if (iframe) {
                        var currentSrc = iframe.src;
                        iframe.src = '';
                        setTimeout(function() {
                            iframe.src = currentSrc;
                        }, 100);
                        console.log('ğŸ”„ iframe å·²åˆ·æ–°:', containerId);
                        return true;
                    }
                }
                console.warn('âš ï¸ æœªæ‰¾åˆ°è¦åˆ·æ–°çš„iframe:', containerId);
                return false;
            } catch (e) {
                console.error('âŒ refreshIframe å¤±è´¥:', e);
                return false;
            }
        };
        
        /**
         * é”€æ¯ iframe
         * Unity è°ƒç”¨: CallWebGLFunction("destroyIframe", "å®¹å™¨ID")
         */
        window.destroyIframe = function(containerId) {
            try {
                var container = document.getElementById(containerId);
                if (container && container.parentNode) {
                    container.parentNode.removeChild(container);
                    console.log('ğŸ—‘ï¸ iframe å·²é”€æ¯:', containerId);
                    return true;
                }
                return false;
            } catch (e) {
                console.error('âŒ destroyIframe å¤±è´¥:', e);
                return false;
            }
        };
        
        // é”®ç›˜ ESC å…³é—­åŠŸèƒ½
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                // æŸ¥æ‰¾æ‰€æœ‰æ´»è·ƒçš„iframeå®¹å™¨å¹¶å…³é—­æœ€æ–°çš„ä¸€ä¸ª
                var containers = document.querySelectorAll('[id$="-container"]');
                if (containers.length > 0) {
                    var latestContainer = containers[containers.length - 1];
                    if (latestContainer.style.display !== 'none') {
                        latestContainer.style.display = 'none';
                        console.log('âŒ¨ï¸ ESC å…³é—­iframe:', latestContainer.id);
                    }
                }
            }
        });
        
        console.log('ğŸš€ iframe ç®¡ç†åŠŸèƒ½å·²åŠ è½½');
        console.log('ğŸ“‹ å¯ç”¨å‡½æ•°:', ['loadIframe', 'setIframeVisibility', 'refreshIframe', 'destroyIframe']);
    </script>
    
    <!-- ä¸»åˆå§‹åŒ–è„šæœ¬ -->
    <script>
        // ğŸ”¥ ä¿®æ­£çš„å…¨å±€é…ç½® - ç§»é™¤å¯¹ LOADER_FILENAME çš„å¼•ç”¨
        window.gameConfig = {
            buildUrl: "Build",
            dataUrl: "Build/{{{ DATA_FILENAME }}}",
            frameworkUrl: "Build/{{{ FRAMEWORK_FILENAME }}}",
            codeUrl: "Build/{{{ CODE_FILENAME }}}",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "{{{ COMPANY_NAME }}}",
            productName: "{{{ PRODUCT_NAME }}}",
            productVersion: "{{{ PRODUCT_VERSION }}}",
        };

        // Unityå®ä¾‹
        var unityInstance = null;
        var container = document.querySelector("#unity-container");
        var canvas = document.querySelector("#unity-canvas");
        var loadingBar = document.querySelector("#unity-loading-bar");
        var progressBarFull = document.querySelector("#unity-progress-bar-full");
        var progressText = document.querySelector("#unity-progress-text");
        var fullscreenButton = document.querySelector("#unity-fullscreen-button");

        // åŠ è½½è¿›åº¦å›è°ƒ
        function updateProgress(progress) {
            progressBarFull.style.width = 100 * progress + "%";
            progressText.textContent = Math.round(progress * 100) + "%";
            
            if (progress >= 1) {
                setTimeout(function() {
                    loadingBar.style.display = "none";
                    fullscreenButton.style.display = "block";
                }, 500);
            }
        }

        // é”™è¯¯å¤„ç†å›è°ƒ
        function onUnityError(error) {
            console.error("Unityé”™è¯¯:", error);
            
            loadingBar.style.display = "none";
            document.getElementById("error-container").style.display = "flex";
            document.getElementById("error-message").textContent = error || "æ¸¸æˆåŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•";
            
            // å‘é€é”™è¯¯æŠ¥å‘Š
            if (window.errorHandler) {
                window.errorHandler.reportError('unity_load_error', error);
            }
        }

        // ğŸ”¥ ä¿®æ­£çš„ Unity åˆå§‹åŒ–å‡½æ•°
        function initializeUnity() {
            // æ£€æŸ¥ createUnityInstance æ˜¯å¦å­˜åœ¨
            if (typeof createUnityInstance === 'undefined') {
                console.error('createUnityInstance ä¸å­˜åœ¨ï¼Œæ£€æŸ¥ framework.js æ˜¯å¦æ­£ç¡®åŠ è½½');
                onUnityError('Unity æ¡†æ¶åŠ è½½å¤±è´¥');
                return;
            }
            
            createUnityInstance(canvas, window.gameConfig, updateProgress)
                .then((unity) => {
                    unityInstance = unity;
                    window.unityInstance = unity; // ğŸ”¥ ä¿å­˜å…¨å±€å¼•ç”¨
                    
                    // è®¾ç½®å…¨å±æŒ‰é’®
                    fullscreenButton.onclick = () => {
                        unityInstance.SetFullscreen(1);
                    };
                    
                    // åˆå§‹åŒ–æ¸¸æˆæ¡¥æ¥
                    if (window.unityBridge) {
                        window.unityBridge.initialize(unityInstance);
                    }
                    
                    // æ¸¸æˆåŠ è½½å®Œæˆäº‹ä»¶
                    window.dispatchEvent(new Event('unity-ready'));
                    
                    console.log("âœ… Unityæ¸¸æˆåˆå§‹åŒ–å®Œæˆ");
                })
                .catch((error) => {
                    console.error("âŒ Unity åˆå§‹åŒ–å¤±è´¥:", error);
                    onUnityError(error);
                });
        }

        // ç§»åŠ¨ç«¯è­¦å‘Šå¤„ç†
        function hideMobileWarning() {
            document.getElementById("mobile-warning").style.display = "none";
        }

        // æ£€æµ‹ç§»åŠ¨ç«¯
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // ğŸ”¥ é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç§»åŠ¨ç«¯æ£€æµ‹
            if (isMobile()) {
                container.className = "unity-mobile";
                // å¦‚æœéœ€è¦æ˜¾ç¤ºç§»åŠ¨ç«¯è­¦å‘Šï¼Œå–æ¶ˆä¸‹é¢æ³¨é‡Š
                // document.getElementById("mobile-warning").style.display = "flex";
            }
            
            // SafariéŸ³é¢‘å…¼å®¹æ€§å¤„ç†ï¼ˆå¦‚æœè„šæœ¬å­˜åœ¨ï¼‰
            if (window.safariCompatibility) {
                window.safariCompatibility.initialize();
            }
            
            // é”™è¯¯å¤„ç†åˆå§‹åŒ–ï¼ˆå¦‚æœè„šæœ¬å­˜åœ¨ï¼‰
            if (window.errorHandler) {
                window.errorHandler.initialize();
            }
            
            // ğŸ”¥ å»¶è¿Ÿåˆå§‹åŒ–Unityï¼Œç¡®ä¿ framework.js å·²åŠ è½½
            setTimeout(function() {
                console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ– Unity...');
                initializeUnity();
            }, 200); // å¢åŠ å»¶è¿Ÿæ—¶é—´
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            if (unityInstance) {
                unityInstance.Quit();
            }
        });

        // çª—å£å¤§å°æ”¹å˜æ—¶è°ƒæ•´ç”»å¸ƒ
        window.addEventListener('resize', function() {
            if (unityInstance && !document.fullscreenElement) {
                // å“åº”å¼è°ƒæ•´é€»è¾‘
                var containerRect = container.getBoundingClientRect();
                var gameWidth = {{{ WIDTH }}};
                var gameHeight = {{{ HEIGHT }}};
                var aspectRatio = gameWidth / gameHeight;
                
                var newWidth = containerRect.width;
                var newHeight = newWidth / aspectRatio;
                
                if (newHeight > window.innerHeight * 0.9) {
                    newHeight = window.innerHeight * 0.9;
                    newWidth = newHeight * aspectRatio;
                }
                
                canvas.style.width = newWidth + 'px';
                canvas.style.height = newHeight + 'px';
            }
        });

        // å…¨å±€é”™è¯¯æ•è·
        window.addEventListener('error', function(event) {
            console.error('é¡µé¢é”™è¯¯:', event.error);
            if (window.errorHandler) {
                window.errorHandler.reportError('page_error', event.error?.message || 'æœªçŸ¥é”™è¯¯');
            }
        });

        // URLå‚æ•°è§£æ - ä¼ é€’ç»™Unity
        function getUrlParams() {
            var params = new URLSearchParams(window.location.search);
            var gameParams = {};
            
            // æå–æ¸¸æˆå‚æ•°
            var paramNames = ['table_id', 'game_type', 'user_id', 'token', 'language', 'currency'];
            paramNames.forEach(function(name) {
                if (params.has(name)) {
                    gameParams[name] = params.get(name);
                }
            });
            
            return gameParams;
        }

        // å‘Unityå‘é€URLå‚æ•°
        window.addEventListener('unity-ready', function() {
            if (unityInstance) {
                var urlParams = getUrlParams();
                if (Object.keys(urlParams).length > 0) {
                    unityInstance.SendMessage('GameManager', 'SetUrlParameters', JSON.stringify(urlParams));
                }
            }
        });
    </script>

    <!-- Google Analytics æˆ–å…¶ä»–åˆ†æè„šæœ¬ -->
    <!-- 
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'GA_MEASUREMENT_ID');
    </script>
    -->
    
</body>
</html>